import React, { useState, useEffect, useRef, Fragment } from 'react';
import { ChevronLeft, ChevronDown, ChevronUp, Plus, Save, Trash2, BarChart3, FileText, Settings, Menu, X, Home, Check } from 'lucide-react';
import { PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';

console.log('âœ… LOGIO: Module loaded successfully');

// ========== window.storage ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå­˜åœ¨ã—ãªã„ç’°å¢ƒå¯¾ç­–ï¼‰ ==========
if (typeof window !== 'undefined' && !window.storage) {
  console.warn('âš ï¸ window.storage ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
  const memoryStorage = new Map();
  window.storage = {
    async get(key) {
      const value = memoryStorage.get(key);
      return value ? { key, value, shared: false } : null;
    },
    async set(key, value) {
      memoryStorage.set(key, value);
      return { key, value, shared: false };
    },
    async delete(key) {
      const deleted = memoryStorage.delete(key);
      return { key, deleted, shared: false };
    },
    async list(prefix) {
      const keys = Array.from(memoryStorage.keys()).filter(k => !prefix || k.startsWith(prefix));
      return { keys, prefix, shared: false };
    }
  };
}

// ========== LOGIOãƒ­ã‚´ï¼ˆæµç·šçš„ãªè±¡ã®ã‚·ãƒ«ã‚¨ãƒƒãƒˆãƒ»ã‚·ãƒãƒãƒ†ã‚£ãƒƒã‚¯ï¼‰ ==========
function LOGIOLogo({ className = "", size = "md", animated = false }) {
  const sizeStyles = {
    xs: "text-lg",      // ãƒ˜ãƒƒãƒ€ãƒ¼ç”¨ (18px)
    sm: "text-xl",      // ã‚µã‚¤ãƒ‰ãƒãƒ¼ç”¨ (20px)
    md: "text-4xl",     // ç¾å ´é¸æŠç”¨ (36px)
    lg: "text-5xl",     // ç¾å ´é¸æŠç”¨ (48px)
    xl: "text-6xl"      // ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”¨ (60px)
  };
  
  const elephantSizes = {
    xs: 40,
    sm: 50,
    md: 90,
    lg: 120,
    xl: 150
  };
  
  return (
    <>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap');
        
        .logio-char {
          display: inline-block;
          opacity: ${animated ? 0 : 1};
        }
        
        ${animated ? `
        .logio-char-animated {
          animation: charFloatUpCinematic 1.8s ease-in-out forwards;
        }
        
        .logio-char-0 { animation-delay: 0s; }
        .logio-char-1 { animation-delay: 0.25s; }
        .logio-char-2 { animation-delay: 0.5s; }
        .logio-char-3 { animation-delay: 0.75s; }
        .logio-char-4 { animation-delay: 1.0s; }
        
        @keyframes charFloatUpCinematic {
          0% {
            opacity: 0;
            transform: translateY(40px) scale(0.95);
          }
          50% {
            opacity: 0.5;
          }
          70% {
            opacity: 1;
            transform: translateY(-8px) scale(1.02);
          }
          100% {
            opacity: 1;
            transform: translateY(0) scale(1);
          }
        }
        
        .elephant-silhouette {
          opacity: 0;
          animation: elephantCinematicEntry 2.5s ease-in-out 1.2s forwards;
        }
        
        @keyframes elephantCinematicEntry {
          0% {
            opacity: 0;
            transform: scale(0.7) translateY(20px);
          }
          40% {
            opacity: 0.06;
          }
          100% {
            opacity: 0.12;
            transform: scale(1) translateY(0);
          }
        }
        ` : ''}
        
        .elephant-static {
          opacity: 0.12;
        }
      `}</style>
      <div className={`relative inline-flex items-center justify-center ${className}`}>
        {/* è±¡ã®ã‚·ãƒ«ã‚¨ãƒƒãƒˆï¼ˆèƒŒæ™¯ãƒ»ã‚·ãƒ£ãƒ¼ãƒ—ãƒ»å¸¸ã«è¡¨ç¤ºï¼‰ */}
        <div className={`absolute inset-0 flex items-center justify-center ${animated ? 'elephant-silhouette' : 'elephant-static'}`}>
          <svg width={elephantSizes[size]} height={elephantSizes[size]} viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
            {/* ã‚·ãƒ³ãƒ—ãƒ«ãªè±¡ã®ã‚·ãƒ«ã‚¨ãƒƒãƒˆï¼ˆé ­ãƒ»è€³ãƒ»é¼»ï¼‰ */}
            <path 
              d="
                M 80,50
                
                C 100,45 120,50 135,65
                C 145,75 150,90 148,105
                C 146,115 140,123 132,127
                
                C 140,130 145,138 143,148
                C 140,160 128,168 115,165
                
                C 108,170 100,173 92,173
                C 85,173 80,170 78,165
                
                C 72,163 68,158 68,152
                C 68,148 70,145 73,143
                
                C 68,140 63,135 60,128
                C 55,115 55,100 60,88
                
                C 50,92 38,98 30,108
                C 22,118 18,132 20,145
                C 22,158 30,168 42,172
                C 48,174 54,173 58,170
                
                C 58,175 56,180 52,184
                C 46,190 38,192 30,190
                C 18,186 10,176 8,163
                C 6,150 10,135 20,123
                C 30,111 45,103 60,100
                
                C 62,85 68,72 78,63
                Z
              "
              fill="#ffffff"
              opacity="0.12"
            />
          </svg>
        </div>
        
        <span 
          className={`text-white ${sizeStyles[size]} relative z-10`}
          style={{ 
            fontFamily: 'Montserrat, -apple-system, BlinkMacSystemFont, sans-serif',
            fontWeight: 600,
            letterSpacing: '0.15em'
          }}
        >
          <span className={`logio-char ${animated ? 'logio-char-animated logio-char-0' : ''}`}>L</span>
          <span className={`logio-char ${animated ? 'logio-char-animated logio-char-1' : ''}`}>O</span>
          <span className={`logio-char ${animated ? 'logio-char-animated logio-char-2' : ''}`}>G</span>
          <span className={`logio-char ${animated ? 'logio-char-animated logio-char-3' : ''}`}>I</span>
          <span className={`logio-char ${animated ? 'logio-char-animated logio-char-4' : ''}`}>O</span>
        </span>
      </div>
    </>
  );
}

// ========== æ•°å­—ã®ç¸å–ã‚Šã‚¹ã‚¿ã‚¤ãƒ« ==========
const amountStrokeStyle = {
  textShadow: '0 0 3px rgba(0,0,0,0.9), 0 0 5px rgba(0,0,0,0.7), 1px 1px 3px rgba(0,0,0,1), -1px -1px 3px rgba(0,0,0,1)'
};

// ========== ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ ==========
const MASTER_DATA = {
  projectNames: ['å†…è£…è§£ä½“', 'ã‚¹ã‚±ãƒ«ãƒˆãƒ³è§£ä½“', 'å»ºç‰©è§£ä½“', 'å¤–è£…è§£ä½“', 'å¤–æ§‹è§£ä½“', 'ã‚¢ã‚¹ãƒ™ã‚¹ãƒˆé™¤å»', 'è¨­å‚™è§£ä½“', 'èº¯ä½“è§£ä½“'],
  salesPersons: ['é–“é‡', 'å…«ãƒ„ç”°', 'æœ¨å¶‹', 'è¥¿', 'éˆ´æœ¨', 'åŸ'],
  employees: ['å±±ç”°å¤ªéƒ', 'ä½è—¤æ¬¡éƒ', 'ç”°ä¸­èŠ±å­', 'éˆ´æœ¨ä¸€éƒ', 'é«˜æ©‹ç¾å’²'],
  inHouseWorkers: ['å…«ãƒ„ç”° æ·³', 'äº”ååµ æ‚ å“‰', 'æŠ˜ç”° å„ªä½œ', 'ç¨²è‘‰ æ­£è¼', 'äº•ã‚±ç”° æµ©å¯¿', 'å¤§é‡ å‹ä¹Ÿ', 'çŸ³æ£® é”ä¹Ÿ', 'ä¸€æ‘ ç¢ç£¨', 'é–“é‡ æ˜‚å¹³'],
  weather: ['æ™´', 'æ›‡', 'é›¨', 'é›ª'],
  workCategories: ['è§£ä½“', 'æ’¤å»', 'æ¸…æƒ', 'é¤Šç”Ÿ', 'æ¬å‡º', 'ãã®ä»–'],
  vehicles: ['2tD', '3tD', '4tD', 'ã‚¢ãƒ¼ãƒ ãƒ­ãƒ¼ãƒ«', 'ãƒ¦ãƒ‹ãƒƒã‚¯', 'è»½ãƒãƒ³'],
  vehicleNumbers: ['100', '181', '200', '201', '226', '300', '312', '381', '451', '480', '500', '858', '909', '1000', '1100', '1810', '2000', '3000', '3214', '3381', '3648', '4000', '4514', '4803', '5000', '5888', '6000', '6994', '7000', '7567', '8000', '8025', '8580', '8736', '9272'],
  heavyMachinery: ['PC78US', 'ãƒãƒƒã‚¯ãƒ›ãƒ¼', 'ãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼', 'ãƒ•ã‚©ãƒ¼ã‚¯'],
  // ä½œæ¥­æ™‚é–“ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆ10åˆ†å˜ä½ã€0:00ã€œ24:00ï¼‰
  workingHoursOptions: (() => {
    const options = [];
    for (let hours = 0; hours <= 24; hours++) {
      for (let minutes = 0; minutes < 60; minutes += 10) {
        if (hours === 24 && minutes > 0) break;
        const h = String(hours).padStart(2, '0');
        const m = String(minutes).padStart(2, '0');
        options.push(`${h}:${m}`);
      }
    }
    return options;
  })(),
  // åŠ´å‹™è²»ã‚’å‰Šé™¤ã—ã€å¤–æ³¨è²»ã«ã€Œäººå·¥ã€ã‚’è¿½åŠ ã€çµŒè²»ã«ã€Œé§è»Šä»£ã€ã€Œé“å…·ä»£ã€ã‚’è¿½åŠ 
  costCategories: {
    'ææ–™è²»': ['é¤Šç”Ÿæ', 'ä»®è¨­æ', 'æ¶ˆè€—å“', 'ç‡ƒæ–™è²»'],
    'å¤–æ³¨è²»': ['äººå·¥', 'é‡æ©Ÿãƒªãƒ¼ã‚¹', 'è»Šä¸¡ãƒªãƒ¼ã‚¹', 'å°‚é–€å·¥äº‹'],
    'çµŒè²»': ['é§è»Šä»£', 'äº¤é€šè²»', 'é€šä¿¡è²»', 'äº‹å‹™ç”¨å“', 'é“å…·ä»£', 'ãã®ä»–']
  },
  wasteTypes: ['æœ¨ããš', 'å»ƒãƒ—ãƒ©', 'ãŒã‚‰é™¶', 'ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ', 'é‡‘å±ããš', 'çŸ³è†ãƒœãƒ¼ãƒ‰', 'ã‚¬ãƒ©ã‚¹'],
  disposalSites: ['æœ¨æ‘å»ºæ', 'äºŒå…‰ç”£æ¥­', 'ã‚®ãƒ—ãƒ­', 'ã‚¦ãƒ ãƒ´ã‚§ãƒ«ãƒˆ', 'æ—¥æ „èˆˆç”£', 'æˆ¸éƒ¨çµ„', 'ãƒªãƒãƒ¼', 'ãƒ¯ã‚¤ã‚¨ãƒ ã‚¨ã‚³ãƒ•ãƒ¥ãƒ¼ãƒãƒ£ãƒ¼', 'æ±å’Œã‚¢ãƒ¼ã‚¯ã‚¹', 'ãƒ¤ãƒã‚¼ãƒ³', 'å…¥é–“ç·‘åŒ–', 'çŸ³å‚ç”£æ¥­', 'ãã®ä»–ï¼ˆç›´æ¥å…¥åŠ›ï¼‰'],
  scrapTypes: ['é‰„ããš', 'éŠ…ç·š', 'ã‚¢ãƒ«ãƒŸ', 'ã‚¹ãƒ†ãƒ³ãƒ¬ã‚¹', 'çœŸé®'],
  buyers: ['å°æ—é‡‘å±', 'é«˜æ©‹é‡‘å±', 'ãƒŠãƒ³ã‚»ã‚¤ã‚¹ãƒãƒ¼ãƒ«', 'æœéƒ¨é‡‘å±', 'ã‚µãƒ³ãƒ“ãƒ¼ãƒ ', 'å…‰ç”°ç”£æ¥­'],
  statuses: ['é€²è¡Œä¸­', 'å®Œäº†', 'ä¸­æ–­']
};

// ========== å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ==========

function Header({ title, showMenuButton = false, onMenuClick, showBackButton = false, onBack }) {
  return (
    <header className="bg-black px-6 py-5 flex items-center sticky top-0 z-40 border-b border-gray-900">
      {showMenuButton && (
        <button onClick={onMenuClick} className="mr-4 text-white hover:text-gray-300 md:hidden">
          <Menu className="w-6 h-6" />
        </button>
      )}
      {showBackButton && (
        <button onClick={onBack} className="mr-4 text-white hover:text-gray-300">
          <X className="w-6 h-6" />
        </button>
      )}
      <LOGIOLogo size="xs" />
      {title && <span className="ml-4 text-gray-400 text-sm font-medium">{title}</span>}
    </header>
  );
}

function Select({ label, labelEn, options, value, onChange, placeholder = "é¸æŠã—ã¦ãã ã•ã„", required = false }) {
  return (
    <div className="mb-6">
      <label className="block text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-2">
        {label} / {labelEn} {required && <span className="text-red-500">*</span>}
      </label>
      <select
        value={value}
        onChange={(e) => onChange(e.target.value)}
        className="w-full px-4 py-3 bg-gray-900/50 border border-gray-700 text-white text-base font-medium rounded-md focus:outline-none focus:border-blue-500 transition-colors"
        required={required}
      >
        <option value="" className="bg-gray-900">{placeholder}</option>
        {options.map((opt) => <option key={opt} value={opt} className="bg-gray-900">{opt}</option>)}
      </select>
    </div>
  );
}

// ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒ¬ã‚¯ãƒˆï¼ˆ2è¡Œè¡¨ç¤ºå¯¾å¿œï¼‰
function DarkSelect({ label, labelEn, options, value, onChange, placeholder = "é¸æŠã—ã¦ãã ã•ã„" }) {
  console.log('ğŸ¯ DarkSelect: Rendering', { label, optionsCount: options?.length, value });
  
  const [isOpen, setIsOpen] = useState(false);
  const dropdownRef = useRef(null);
  
  // é¸æŠä¸­ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å–å¾—
  const selectedOption = options.find(opt => opt.value === value);
  
  // å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
        setIsOpen(false);
      }
    };
    
    if (isOpen) {
      document.addEventListener('mousedown', handleClickOutside);
      return () => document.removeEventListener('mousedown', handleClickOutside);
    }
  }, [isOpen]);
  
  const handleSelect = (optionValue) => {
    onChange(optionValue);
    setIsOpen(false);
  };
  
  return (
    <div className="mb-6 relative" ref={dropdownRef}>
      <label className="block text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-2">
        {label} / {labelEn}
      </label>
      
      {/* é¸æŠãƒœã‚¿ãƒ³ */}
      <button
        type="button"
        onClick={() => setIsOpen(!isOpen)}
        className="w-full px-4 py-3 bg-gray-900/50 border border-gray-700 rounded-md text-left focus:outline-none focus:border-blue-500 transition-colors relative"
      >
        {selectedOption ? (
          <div>
            <div className="text-white text-base font-medium">{selectedOption.title}</div>
            {selectedOption.subtitle && (
              <div className="text-gray-500 text-xs mt-1">{selectedOption.subtitle}</div>
            )}
          </div>
        ) : (
          <div className="text-gray-500 text-base">{placeholder}</div>
        )}
        <ChevronDown className={`absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500 transition-transform ${isOpen ? 'rotate-180' : ''}`} />
      </button>
      
      {/* ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ */}
      {isOpen && (
        <div className="absolute left-0 right-0 z-50 mt-1 bg-gray-900 border border-gray-700 rounded-md shadow-xl max-h-80 overflow-y-auto">
          {options.map((option) => (
            <button
              key={option.value}
              type="button"
              onClick={() => handleSelect(option.value)}
              className="w-full px-4 py-3 text-left hover:bg-gray-800 transition-colors border-b border-gray-800 last:border-b-0 relative"
            >
              <div className="pr-8">
                <div className="text-white text-base font-medium">{option.title}</div>
                {option.subtitle && (
                  <div className="text-gray-500 text-xs mt-1">{option.subtitle}</div>
                )}
              </div>
              {value === option.value && (
                <Check className="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-blue-500" />
              )}
            </button>
          ))}
        </div>
      )}
    </div>
  );
}

// ãƒãƒƒãƒ—å¼ãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆï¼ˆè»Šä¸¡ãƒ»é‡æ©Ÿç”¨ï¼‰
// ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³å¼è¤‡æ•°é¸æŠï¼ˆã‚¹ãƒãƒ›æœ€é©åŒ–ï¼‰
function MultiSelectDropdown({ label, labelEn, options, selected = [], onChange, placeholder = "é¸æŠã—ã¦ãã ã•ã„" }) {
  const [isOpen, setIsOpen] = useState(false);
  
  const toggleOption = (option) => {
    if (selected.includes(option)) {
      onChange(selected.filter(item => item !== option));
    } else {
      onChange([...selected, option]);
    }
  };
  
  return (
    <div className="mb-6">
      <label className="block text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-2">
        {label} / {labelEn}
      </label>
      
      {/* é¸æŠãƒœã‚¿ãƒ³ */}
      <button
        type="button"
        onClick={() => setIsOpen(!isOpen)}
        className="w-full px-4 py-3 bg-gray-900/50 border border-gray-700 text-white rounded-md focus:outline-none focus:border-blue-500 text-left flex justify-between items-center"
      >
        <span className="text-base">
          {selected.length > 0 ? `${selected.length}ä»¶é¸æŠ` : placeholder}
        </span>
        <ChevronDown className={`w-5 h-5 transition-transform ${isOpen ? 'rotate-180' : ''}`} />
      </button>
      
      {/* é¸æŠæ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ è¡¨ç¤º */}
      {selected.length > 0 && (
        <div className="mt-2 text-xs text-gray-400">
          {selected.join('ã€')}
        </div>
      )}
      
      {/* ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */}
      {isOpen && (
        <div className="mt-2 bg-gray-900 border border-gray-700 rounded-md max-h-60 overflow-y-auto">
          {options.map((option) => {
            const isSelected = selected.includes(option);
            return (
              <button
                key={option}
                type="button"
                onClick={() => toggleOption(option)}
                className={`w-full px-4 py-3 text-left text-sm transition-colors flex items-center justify-between ${
                  isSelected
                    ? 'bg-blue-600 text-white'
                    : 'text-gray-300 hover:bg-gray-800'
                }`}
              >
                <span>{option}</span>
                {isSelected && <Check className="w-4 h-4" />}
              </button>
            );
          })}
        </div>
      )}
    </div>
  );
}

function TextInput({ label, labelEn, value, onChange, placeholder = "", type = "text", required = false }) {
  return (
    <div className="mb-4">
      <label className="block text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-2">
        {label} / {labelEn} {required && <span className="text-red-500">*</span>}
      </label>
      <input
        type={type}
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder={placeholder}
        className="w-full px-4 py-3 bg-gray-800 border border-gray-700 text-white rounded-md focus:outline-none focus:border-blue-500"
        required={required}
      />
    </div>
  );
}

// æ•°å€¤å…¥åŠ›ç”¨ï¼ˆæ‰‹å‹•å…¥åŠ›ã€ã‚¹ãƒãƒ›ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å¯¾å¿œï¼‰â€»çµ±ä¸€ç‰ˆ
function NumericInput({ label, labelEn, value, onChange, placeholder = "0", unit = "", min = 0 }) {
  const toNumberString = (v) => String(v ?? '').replace(/[^\d.]/g, ''); // æ•°å­—ã¨å°æ•°ç‚¹ä»¥å¤–é™¤å»
  const handleChange = (raw) => {
    const cleaned = toNumberString(raw);
    // ç”»é¢è¡¨ç¤ºã¯æ–‡å­—åˆ—ã®ã¾ã¾æŒã¤ï¼ˆä»Šã®å®Ÿè£…ã¨äº’æ›ï¼‰
    if (cleaned === '') return onChange('');
    // ãƒã‚¤ãƒŠã‚¹ã‚’è¨±ã•ãªã„ï¼ˆmin=0 ãƒ‡ãƒ•ã‚©ï¼‰
    const num = Math.max(min, parseFloat(cleaned) || 0);
    // ä½™è¨ˆãªæ¡ã‚’æˆ»ã•ãªã„ãŸã‚ã€å…¥åŠ›ä¸­ã¯ cleaned ã‚’å„ªå…ˆã§ã‚‚OK
    onChange(String(num));
  };
  return (
    <div className="mb-4">
      <label className="block text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-2">
        {label} / {labelEn}
      </label>
      <div className="relative">
        <input
          type="text"
          inputMode="numeric"
          pattern="[0-9]*"
          value={value}
          onChange={(e) => handleChange(e.target.value)}
          placeholder={placeholder}
          className="w-full px-4 py-4 pr-12 bg-gray-800 border border-gray-700 text-white text-2xl font-semibold text-right rounded-md focus:outline-none focus:border-blue-500 tabular-nums"
          style={{ fontFamily: '-apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", sans-serif' }}
        />
        {unit && (
          <span className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 text-sm font-medium">
            {unit}
          </span>
        )}
      </div>
    </div>
  );
}

function TextArea({ label, labelEn, value, onChange, placeholder = "", rows = 3 }) {
  return (
    <div className="mb-4">
      <label className="block text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-2">
        {label} / {labelEn}
      </label>
      <textarea
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder={placeholder}
        rows={rows}
        className="w-full px-4 py-3 bg-gray-800 border border-gray-700 text-white rounded-md focus:outline-none focus:border-blue-500 resize-none"
      />
    </div>
  );
}

// å¤§ãã„ã‚¹ãƒ†ãƒƒãƒ‘ãƒ¼UIï¼ˆä½œæ¥­å“¡æ•°ç”¨ï¼‰
function BigStepper({ label, labelEn, value, onChange, min = 0, max = 99 }) {
  return (
    <div className="mb-4">
      <label className="block text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-2">
        {label} / {labelEn}
      </label>
      <div className="flex items-center gap-4 bg-gray-900/50 rounded-md p-4">
        <button
          type="button"
          onClick={() => onChange(Math.max(min, value - 1))}
          className="w-14 h-14 bg-gray-800 hover:bg-gray-700 text-white rounded-lg flex items-center justify-center text-3xl font-bold transition-colors"
        >
          âˆ’
        </button>
        <div className="flex-1 text-center">
          <div className="text-5xl font-bold text-white tabular-nums">{value}</div>
          <div className="text-xs text-gray-500 mt-1">äºº</div>
        </div>
        <button
          type="button"
          onClick={() => onChange(Math.min(max, value + 1))}
          className="w-14 h-14 bg-gray-800 hover:bg-gray-700 text-white rounded-lg flex items-center justify-center text-3xl font-bold transition-colors"
        >
          +
        </button>
      </div>
    </div>
  );
}

// é‡‘é¡å…¥åŠ›ç”¨ï¼ˆæ‰‹å‹•å…¥åŠ›ã€ã‚¹ãƒãƒ›ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å¯¾å¿œï¼‰
function AmountInput({ label, labelEn, value, onChange, placeholder = "0" }) {
  return (
    <div className="mb-4">
      <label className="block text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-2">
        {label} / {labelEn}
      </label>
      <div className="relative">
        <span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 text-xl font-semibold">Â¥</span>
        <input
          type="text"
          inputMode="numeric"
          pattern="[0-9]*"
          value={value}
          onChange={(e) => onChange(e.target.value)}
          placeholder={placeholder}
          className="w-full pl-10 pr-4 py-4 bg-gray-800 border border-gray-700 text-white text-2xl font-semibold text-right rounded-md focus:outline-none focus:border-blue-500 tabular-nums"
          style={{ fontFamily: '-apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", sans-serif' }}
        />
      </div>
    </div>
  );
}

function Button({ children, onClick, variant = 'primary', className = '', icon: Icon, disabled = false }) {
  const baseClass = "w-full px-6 py-4 font-bold text-lg transition-all flex items-center justify-center gap-2";
  const variants = {
    primary: disabled ? "bg-gray-400 text-gray-200 cursor-not-allowed" : "bg-blue-900 text-white hover:bg-blue-800",
    secondary: "bg-white text-black border-2 border-gray-300 hover:bg-gray-100",
    danger: "bg-red-600 text-white hover:bg-red-500"
  };
  
  return (
    <button onClick={onClick} className={`${baseClass} ${variants[variant]} ${className}`} disabled={disabled}>
      {Icon && <Icon className="w-5 h-5" />}
      {children}
    </button>
  );
}

// æ ªä¾¡ã‚¢ãƒ—ãƒªé¢¨ã®ãƒ¡ãƒˆãƒªãƒƒã‚¯ã‚«ãƒ¼ãƒ‰
function MetricCard({ label, value, unit = "", type = "neutral", rawValue = 0, subValue = null, subLabel = null }) {
  const styles = {
    neutral: "bg-gray-900/50",
    revenue: "bg-gray-900/50",
    cost: "bg-gray-900/50",
    profit: "bg-gray-900/50",
    rate: "bg-gray-900/50",
    scrap: "bg-gray-900/50"
  };

  // æ•°å­—ã®ã¿ã«è‰²ã‚’ä»˜ã‘ã‚‹ï¼ˆãƒ©ãƒ™ãƒ«ã¯ã™ã¹ã¦åŒè‰²ï¼‰
  const textStyles = {
    neutral: "text-white",
    revenue: "text-white",                                           // å£²ä¸Š: ãƒ›ãƒ¯ã‚¤ãƒˆ
    cost: "text-red-400/80",                                         // åŸä¾¡: è–„ã„èµ¤
    profit: rawValue > 0 ? "text-blue-400/90" : "text-red-400/80",  // ç²—åˆ©: ãƒ—ãƒ©ã‚¹â†’æ§ãˆã‚ãªé’ / ãƒã‚¤ãƒŠã‚¹â†’è–„ã„èµ¤
    rate: "text-white",                                              // ç²—åˆ©ç‡: ãƒ›ãƒ¯ã‚¤ãƒˆ
    scrap: "text-white"                                              // ã‚¹ã‚¯ãƒ©ãƒƒãƒ—: ãƒ›ãƒ¯ã‚¤ãƒˆ
  };

  return (
    <div className={`${styles[type]} rounded-md p-4 flex flex-col gap-2`}>
      {/* ãƒ©ãƒ™ãƒ«: ã™ã¹ã¦åŒè‰²ï¼ˆtext-gray-500ï¼‰ */}
      <p className="text-gray-500 text-[10px] font-medium uppercase tracking-wider">{label}</p>
      <div>
        {/* æ•°å­—: ã‚¿ã‚¤ãƒ—ã”ã¨ã«è‰²åˆ†ã‘ã€text-xlã«ç¸®å° */}
        <p className={`text-xl font-semibold ${textStyles[type]} tabular-nums`} style={{ fontFamily: '-apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", sans-serif' }}>
          {unit}{value}
        </p>
        {subValue && (
          <p className="text-gray-500 text-xs mt-1 tabular-nums">
            {subLabel && <span className="mr-1">{subLabel}</span>}
            {subValue}
          </p>
        )}
      </div>
    </div>
  );
}


function SectionHeader({ title }) {
  return (
    <div className="mb-4 mt-8">
      <h2 className="text-sm font-semibold text-white uppercase tracking-wider">{title}</h2>
    </div>
  );
}

// ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
function StepIndicator({ currentStep, totalSteps }) {
  return (
    <div className="mb-6 bg-gray-100 p-4">
      <div className="flex items-center justify-between mb-2">
        {[...Array(totalSteps)].map((_, i) => (
          <Fragment key={i}>
            <div className={`flex items-center justify-center w-10 h-10 rounded-full font-bold ${
              i + 1 <= currentStep ? 'bg-gray-900 text-white' : 'bg-gray-300 text-gray-600'
            }`}>
              {i + 1 < currentStep ? <Check className="w-6 h-6" /> : i + 1}
            </div>
            {i < totalSteps - 1 && (
              <div className={`flex-1 h-1 mx-2 ${i + 1 < currentStep ? 'bg-gray-900' : 'bg-gray-300'}`} />
            )}
          </Fragment>
        ))}
      </div>
      <div className="text-center text-sm font-medium text-gray-700">
        ã‚¹ãƒ†ãƒƒãƒ— {currentStep} / {totalSteps}
      </div>
    </div>
  );
}

// ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ==========
const generateId = (prefix) => {
  if (crypto?.randomUUID) return `${prefix}-${crypto.randomUUID()}`;
  return `${prefix}-${Date.now()}-${Math.random().toString(16).slice(2)}`;
};

const formatCurrency = (num) => new Intl.NumberFormat('ja-JP').format(num);

const getDayOfWeek = (dateStr) => {
  const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
  const date = new Date(dateStr);
  return days[date.getDay()];
};

// ========== ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ==========
function Sidebar({ currentPage, onNavigate, sidebarOpen, setSidebarOpen }) {
  const navItems = [
    { id: 'home', label: 'ãƒ›ãƒ¼ãƒ ', icon: Home },
    { id: 'input', label: 'æ—¥å ±å…¥åŠ›', icon: Plus },
    { id: 'list', label: 'æ—¥å ±ä¸€è¦§', icon: FileText },
    { id: 'analysis', label: 'åŸä¾¡åˆ†æ', icon: BarChart3 },
    { id: 'settings', label: 'è¨­å®šãƒ»ç·¨é›†', icon: Settings }
  ];

  const handleNavigate = (page) => {
    onNavigate(page);
    setSidebarOpen(false);
  };

  return (
    <>
      {/* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚µã‚¤ãƒ‰ãƒãƒ¼ */}
      <div className="hidden md:flex md:w-64 md:flex-col md:fixed md:inset-y-0 bg-black text-white z-50 border-r border-gray-900">
        <div className="flex-1 flex flex-col pt-5 pb-4 overflow-y-auto">
          <div className="flex items-center flex-shrink-0 px-4 mb-8">
            <LOGIOLogo size="sm" />
          </div>
          
          <nav className="flex-1 px-2 space-y-1">
            {navItems.map((item) => {
              const Icon = item.icon;
              return (
                <button
                  key={item.id}
                  onClick={() => handleNavigate(item.id)}
                  className={`w-full group flex items-center px-3 py-3 text-sm font-medium transition-colors min-h-[48px] ${
                    currentPage === item.id
                      ? 'bg-white text-black'
                      : 'text-gray-300 hover:bg-gray-800 hover:text-white'
                  }`}
                >
                  <Icon className="mr-3 h-5 w-5 flex-shrink-0" />
                  {item.label}
                </button>
              );
            })}
          </nav>
        </div>
      </div>

      {/* ãƒ¢ãƒã‚¤ãƒ«ã‚µã‚¤ãƒ‰ãƒãƒ¼ */}
      {sidebarOpen && (
        <div className="md:hidden fixed inset-0 z-50 flex">
          <div className="fixed inset-0 bg-black bg-opacity-75" onClick={() => setSidebarOpen(false)} />
          
          <div className="relative flex-1 flex flex-col max-w-xs w-full bg-black">
            <div className="absolute top-0 right-0 -mr-12 pt-2">
              <button
                onClick={() => setSidebarOpen(false)}
                className="ml-1 flex items-center justify-center h-10 w-10 rounded-full focus:outline-none"
              >
                <X className="h-6 w-6 text-white" />
              </button>
            </div>
            
            <div className="flex-1 h-0 pt-5 pb-4 overflow-y-auto">
              <div className="flex items-center flex-shrink-0 px-4 mb-8">
                <LOGIOLogo size="sm" />
              </div>
              
              <nav className="px-2 space-y-1">
                {navItems.map((item) => {
                  const Icon = item.icon;
                  return (
                    <button
                      key={item.id}
                      onClick={() => handleNavigate(item.id)}
                      className={`w-full group flex items-center px-3 py-3 text-sm font-medium transition-colors min-h-[48px] ${
                        currentPage === item.id
                          ? 'bg-white text-black'
                          : 'text-gray-300 hover:bg-gray-800 hover:text-white'
                      }`}
                    >
                      <Icon className="mr-3 h-5 w-5 flex-shrink-0" />
                      {item.label}
                    </button>
                  );
                })}
              </nav>
            </div>
          </div>
        </div>
      )}
    </>
  );
}

// ========== ç”»é¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ==========

// ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢ï¼ˆèµ·å‹•æ™‚ã®ã¿ï¼‰
function SplashScreen() {
  return (
    <div className="min-h-screen bg-black flex items-center justify-center">
      <LOGIOLogo size="xl" animated={true} />
    </div>
  );
}

// ç¾å ´é¸æŠå°‚ç”¨ç”»é¢
function SiteSelectionPage({ sites, onSelectSite, onRequestAddSite }) {
  console.log('ğŸ—ï¸ SiteSelectionPage: Rendering', { sitesCount: sites.length });
  
  // ç¾å ´ãŒå­˜åœ¨ã—ãªã„å ´åˆ
  if (sites.length === 0) {
    console.log('ğŸ“ SiteSelectionPage: No sites - showing add site form');
    return (
      <div className="min-h-screen bg-black flex items-center justify-center px-4">
        <div className="max-w-md w-full">
          {/* ãƒ­ã‚´ */}
          <div className="flex flex-col items-center justify-center mb-10">
            <LOGIOLogo size="lg" />
          </div>
          
          {/* ç¾å ´æœªç™»éŒ²ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */}
          <div className="text-center mb-8">
            <p className="text-gray-600 text-sm mb-6">ç¾å ´ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
            
            {/* æ–°è¦ç¾å ´ç™»éŒ²ãƒœã‚¿ãƒ³ */}
            <button
              onClick={() => {
                console.log('ğŸ”˜ SiteSelectionPage: æ–°è¦ç¾å ´ç™»éŒ²ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                onRequestAddSite();
              }}
              className="w-full px-6 py-4 bg-gray-900/30 border border-gray-700 rounded-md text-gray-400 hover:bg-gray-900/50 hover:border-gray-600 hover:text-gray-300 transition-colors flex items-center justify-center gap-3"
            >
              <Plus className="w-5 h-5" />
              <span className="text-base font-medium">æ–°è¦ç¾å ´ã‚’ç™»éŒ²</span>
            </button>
          </div>
        </div>
      </div>
    );
  }
  
  // ç¾å ´ãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼ˆå¾“æ¥ã®UIï¼‰
  const siteOptions = sites.map(site => ({
    value: site.name,
    title: site.name,
    subtitle: site.projectNumber ? `PROJECT NO.: ${site.projectNumber}` : 'PROJECT NO.: -'
  }));
  
  return (
    <div className="min-h-screen bg-black flex items-center justify-center px-4">
      <div className="max-w-md w-full">
        {/* ãƒ­ã‚´ */}
        <div className="flex flex-col items-center justify-center mb-10">
          <LOGIOLogo size="lg" />
        </div>
        
        {/* ç¾å ´é¸æŠ */}
        <DarkSelect
          label="ç¾å ´"
          labelEn="PROJECT"
          options={siteOptions}
          value=""
          onChange={onSelectSite}
          placeholder="ç¾å ´ã‚’é¸æŠã—ã¦ãã ã•ã„"
        />
      </div>
    </div>
  );
}

function HomePage({ sites, selectedSite, onSelectSite, onNavigate, totals, projectInfo }) {
  // DarkSelectç”¨ã®optionsé…åˆ—ã‚’ä½œæˆ
  const siteOptions = sites.map(site => ({
    value: site.name,
    title: site.name,
    subtitle: site.projectNumber ? `PROJECT NO.: ${site.projectNumber}` : 'PROJECT NO.: -'
  }));
  
  return (
    <div className="max-w-2xl mx-auto px-4 py-6 bg-black min-h-screen">
      {/* ç¾å ´é¸æŠ */}
      <DarkSelect
        label="ç¾å ´"
        labelEn="PROJECT"
        options={siteOptions}
        value={selectedSite}
        onChange={onSelectSite}
        placeholder="ç¾å ´ã‚’é¸æŠã—ã¦ãã ã•ã„"
      />

      {selectedSite && (
        <>
          {/* ãƒ¡ã‚¤ãƒ³KPI: 2Ã—2ã‚°ãƒªãƒƒãƒ‰ï¼ˆæ ªä¾¡ã‚¢ãƒ—ãƒªé¢¨ï¼‰ */}
          <div className="mb-3">
            <div className="grid grid-cols-2 gap-3">
              <MetricCard label="å£²ä¸Š / Revenue" value={formatCurrency(totals.totalRevenue)} unit="Â¥" type="revenue" rawValue={totals.totalRevenue} />
              <MetricCard label="åŸä¾¡ / Cost" value={formatCurrency(totals.accumulatedCost)} unit="Â¥" type="cost" rawValue={totals.accumulatedCost} />
              <MetricCard label="ç²—åˆ© / Profit" value={formatCurrency(totals.grossProfit)} unit="Â¥" type="profit" rawValue={totals.grossProfit} />
              <MetricCard 
                label="ç²—åˆ©ç‡ / Margin" 
                value={`${totals.grossProfitRateContract}%`} 
                unit="" 
                type="rate" 
                rawValue={parseFloat(totals.grossProfitRateContract)}
                subValue={`(è¾¼ã¿: ${totals.grossProfitRateWithScrap}%)`}
              />
            </div>
          </div>

          {/* ã‚¹ã‚¯ãƒ©ãƒƒãƒ—å£²ä¸Š - MetricCardã§çµ±ä¸€ */}
          {totals.accumulatedScrap > 0 && (
            <div className="mb-8">
              <MetricCard 
                label="ã‚¹ã‚¯ãƒ©ãƒƒãƒ— / Scrap" 
                value={formatCurrency(totals.accumulatedScrap)} 
                unit="Â¥" 
                type="scrap" 
                rawValue={totals.accumulatedScrap} 
              />
            </div>
          )}

          {/* ã‚¿ãƒ–é¢¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */}
          <div className="mt-8 mb-6">
            <div className="grid grid-cols-2 gap-3">
              <button 
                onClick={() => onNavigate('input')}
                className="flex items-center justify-center gap-2 py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
              >
                <Plus className="w-5 h-5" />
                <span className="font-medium">æ—¥å ±å…¥åŠ›</span>
              </button>
              <button 
                onClick={() => onNavigate('list')}
                className="flex items-center justify-center gap-2 py-4 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg transition-colors"
              >
                <FileText className="w-5 h-5" />
                <span className="font-medium">æ—¥å ±ä¸€è¦§</span>
              </button>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-3 mb-3">
            <button 
              onClick={() => onNavigate('analysis')}
              className="flex items-center justify-center gap-2 py-4 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg transition-colors"
            >
              <BarChart3 className="w-5 h-5" />
              <span className="font-medium">åŸä¾¡åˆ†æ</span>
            </button>
            <button 
              onClick={() => onNavigate('settings')}
              className="flex items-center justify-center gap-2 py-4 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg transition-colors"
            >
              <Settings className="w-5 h-5" />
              <span className="font-medium">è¨­å®š</span>
            </button>
          </div>
        </>
      )}
    </div>
  );
}

function ProjectSettingsPage({ sites, selectedSite, projectInfo, setProjectInfo, onSave, onAddSite, onDeleteSite, onNavigate }) {
  const [showAddSite, setShowAddSite] = useState(false);
  const [newSiteName, setNewSiteName] = useState('');

  const handleAddSite = () => {
    if (!newSiteName.trim()) return alert('ç¾å ´åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    onAddSite(newSiteName);
    setNewSiteName('');
    setShowAddSite(false);
  };

  const handleDeleteSite = (siteName) => {
    if (!confirm(`ç¾å ´ã€Œ${siteName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\né–¢é€£ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã¨æ—¥å ±ã‚‚ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) return;
    onDeleteSite(siteName);
  };

  return (
    <div className="max-w-2xl mx-auto px-6 py-8">
      {/* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */}
      <div className="mb-4">
        <button
          onClick={() => onNavigate('home')}
          className="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg transition-colors font-medium text-sm flex items-center gap-2"
        >
          <X className="w-4 h-4" />
          é–‰ã˜ã‚‹
        </button>
      </div>
      
      <SectionHeader title="ç¾å ´ç®¡ç† / Site Management" />
      
      {!showAddSite ? (
        <button
          onClick={() => setShowAddSite(true)}
          className="w-full mb-6 px-4 py-3 bg-blue-900 text-white text-base font-bold hover:bg-blue-800 transition-colors flex items-center justify-center gap-2"
        >
          <Plus className="w-5 h-5" />
          æ–°è¦ç¾å ´ã‚’è¿½åŠ 
        </button>
      ) : (
        <div className="mb-6 p-4 bg-gray-50 border-2 border-gray-300">
          <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">
            æ–°è¦ç¾å ´å / New Site Name
          </label>
          <input
            type="text"
            value={newSiteName}
            onChange={(e) => setNewSiteName(e.target.value)}
            placeholder="ä¾‹: æ¸‹è°·ã€‡ã€‡ãƒ“ãƒ«è§£ä½“å·¥äº‹"
            className="w-full px-4 py-3 bg-white border-2 border-gray-300 text-black text-base font-medium focus:outline-none focus:border-blue-900 mb-3"
          />
          <div className="grid grid-cols-2 gap-2">
            <button
              onClick={handleAddSite}
              className="px-4 py-3 bg-blue-900 text-white font-bold hover:bg-blue-800 transition-colors"
            >
              è¿½åŠ 
            </button>
            <button
              onClick={() => { setShowAddSite(false); setNewSiteName(''); }}
              className="px-4 py-3 bg-white border-2 border-gray-300 text-black font-bold hover:bg-gray-100 transition-colors"
            >
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
          </div>
        </div>
      )}

      {sites.length > 0 && (
        <div className="mb-8">
          <p className="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">
            ç™»éŒ²æ¸ˆã¿ç¾å ´ / Registered Sites ({sites.length})
          </p>
          <div className="space-y-2">
            {sites.map((site, index) => (
              <div key={index} className="flex items-center justify-between p-3 bg-gray-50 border border-gray-300">
                <span className="text-base font-medium">{site.name}</span>
                <button
                  onClick={() => handleDeleteSite(site.name)}
                  className="px-3 py-1 bg-red-600 text-white text-sm font-bold hover:bg-red-500 transition-colors"
                >
                  å‰Šé™¤
                </button>
              </div>
            ))}
          </div>
        </div>
      )}

      {selectedSite && (
        <>
          <SectionHeader title={`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ç·¨é›† / Project Settings (${selectedSite})`} />
          
          {/* PROJECT NO. - è¡¨ç¤ºã®ã¿ï¼ˆç·¨é›†ä¸å¯ï¼‰ */}
          <div className="mb-6">
            <label className="block text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-2">
              å·¥äº‹ç•ªå· / PROJECT NO.
            </label>
            <div className="px-4 py-4 bg-gray-900/30 border border-gray-800 rounded-md">
              <div className="text-white text-base font-semibold tabular-nums">
                {projectInfo.projectNumber || 'æœªè¨­å®š'}
              </div>
              <p className="text-xs text-gray-600 mt-1">â€» è‡ªå‹•æ¡ç•ªã•ã‚Œã¾ã™ï¼ˆç·¨é›†ä¸å¯ï¼‰</p>
            </div>
          </div>
          
          <Select label="å·¥äº‹å" labelEn="Project Name" options={MASTER_DATA.projectNames} value={projectInfo.projectName} onChange={(val) => setProjectInfo({...projectInfo, projectName: val})} />
          <TextInput label="ç™ºæ³¨è€…" labelEn="Client" value={projectInfo.client} onChange={(val) => setProjectInfo({...projectInfo, client: val})} placeholder="â—‹â—‹å»ºè¨­æ ªå¼ä¼šç¤¾" />
          <TextInput label="ç¾å ´ä½æ‰€" labelEn="Site Location" value={projectInfo.workLocation} onChange={(val) => setProjectInfo({...projectInfo, workLocation: val})} placeholder="æ±äº¬éƒ½æ¸‹è°·åŒº..." />
          <Select label="å–¶æ¥­æ‹…å½“" labelEn="Sales" options={MASTER_DATA.salesPersons} value={projectInfo.salesPerson} onChange={(val) => setProjectInfo({...projectInfo, salesPerson: val})} />
          <Select label="ç¾å ´è²¬ä»»è€…" labelEn="Site Manager" options={MASTER_DATA.employees} value={projectInfo.siteManager} onChange={(val) => setProjectInfo({...projectInfo, siteManager: val})} />

          <div className="grid grid-cols-2 gap-4 mb-6">
            <div>
              <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">å·¥æœŸé–‹å§‹ / Start</label>
              <input type="date" value={projectInfo.startDate} onChange={(e) => setProjectInfo({...projectInfo, startDate: e.target.value})} className="w-full px-4 py-3 bg-white border-2 border-gray-300 text-black text-base font-medium focus:outline-none focus:border-blue-900" />
            </div>
            <div>
              <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">å·¥æœŸçµ‚äº† / End</label>
              <input type="date" value={projectInfo.endDate} onChange={(e) => setProjectInfo({...projectInfo, endDate: e.target.value})} className="w-full px-4 py-3 bg-white border-2 border-gray-300 text-black text-base font-medium focus:outline-none focus:border-blue-900" />
            </div>
          </div>

          <TextInput label="å£²ä¸Šï¼ˆç¨æŠœï¼‰" labelEn="Revenue" type="number" value={projectInfo.contractAmount} onChange={(val) => setProjectInfo({...projectInfo, contractAmount: val})} placeholder="5000000" />
          <TextInput label="è¿½åŠ é‡‘é¡ï¼ˆç¨æŠœï¼‰" labelEn="Additional Amount" type="number" value={projectInfo.additionalAmount} onChange={(val) => setProjectInfo({...projectInfo, additionalAmount: val})} placeholder="0" />
          <Select label="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹" labelEn="Status" options={MASTER_DATA.statuses} value={projectInfo.status} onChange={(val) => setProjectInfo({...projectInfo, status: val})} />

          <Button onClick={onSave} icon={Save}>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’ä¿å­˜</Button>
        </>
      )}
    </div>
  );
}

// ========== 3ã‚¹ãƒ†ãƒƒãƒ—æ—¥å ±å…¥åŠ› ==========
function ReportInputPage({ onSave, onNavigate }) {
  const [currentStep, setCurrentStep] = useState(1);
  
  // Step1: åŸºæœ¬æƒ…å ±
  const [report, setReport] = useState({
    date: new Date().toISOString().split('T')[0],
    weather: '',
    workCategory: '',
    recorder: ''
  });

  // Step2: ä½œæ¥­å†…å®¹ãƒ»äººå“¡ãƒ»ç¨¼åƒ
  const [workDetails, setWorkDetails] = useState({
    workContent: '',
    workingMinutes: 0,  // ä½œæ¥­æ™‚é–“ï¼ˆåˆ†ï¼‰
    inHouseWorkers: 0,
    inHouseWorkerNames: [],
    vehicleType: '',    // è»Šç¨®
    vehicleNumber: '',  // è»Šç•ª
    heavyMachinery: []
  });
  
  // ä½œæ¥­å“¡åé¸æŠæ™‚ã«äººæ•°ã‚’è‡ªå‹•åæ˜ 
  const handleWorkerNamesChange = (names) => {
    setWorkDetails({
      ...workDetails,
      inHouseWorkerNames: names,
      inHouseWorkers: names.length
    });
  };
  
  // ä½œæ¥­æ™‚é–“ï¼ˆæ™‚:åˆ†ï¼‰ã‚’åˆ†ã«å¤‰æ›
  const timeToMinutes = (timeStr) => {
    if (!timeStr) return 0;
    const [hours, minutes] = timeStr.split(':').map(Number);
    return (hours * 60) + minutes;
  };
  
  // åˆ†ã‚’æ™‚:åˆ†ã«å¤‰æ›
  const minutesToTime = (minutes) => {
    if (!minutes) return '00:00';
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
  };

  // Step3: åŸä¾¡ãƒ»å»ƒæ£„ç‰©ãƒ»ã‚¹ã‚¯ãƒ©ãƒƒãƒ—
  const [costLines, setCostLines] = useState([]);
  const [currentCost, setCurrentCost] = useState({ costCategory: '', costItem: '', quantity: '', unitPrice: '' });
  const [wasteLines, setWasteLines] = useState([]);
  const [currentWaste, setCurrentWaste] = useState({ wasteType: '', disposalSite: '', manifestNumber: '', quantity: '', unitDisposalCost: '' });
  const [customDisposalSite, setCustomDisposalSite] = useState('');
  const [scrapLines, setScrapLines] = useState([]);
  const [currentScrap, setCurrentScrap] = useState({ scrapType: '', buyer: '', quantity: '', unitPrice: '' });

  // ã‚¹ãƒ†ãƒƒãƒ—å¤‰æ›´æ™‚ã«ç”»é¢ã‚’æœ€ä¸Šéƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  useEffect(() => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }, [currentStep]);

  // ä¸‹æ›¸ãä¿å­˜ãƒ»èª­ã¿è¾¼ã¿
  useEffect(() => {
    loadDraft();
  }, []);

  const loadDraft = async () => {
    try {
      const draft = await window.storage.get('logio-draft-report');
      if (draft?.value) {
        const data = JSON.parse(draft.value);
        setReport(data.report || report);
        setWorkDetails({
          workContent: data.workDetails?.workContent || '',
          workingMinutes: data.workDetails?.workingMinutes || 0,
          inHouseWorkers: data.workDetails?.inHouseWorkers || 0,
          inHouseWorkerNames: data.workDetails?.inHouseWorkerNames || [],
          vehicleType: data.workDetails?.vehicleType || '',
          vehicleNumber: data.workDetails?.vehicleNumber || '',
          heavyMachinery: data.workDetails?.heavyMachinery || []
        });
        setCostLines(data.costLines || []);
        setWasteLines(data.wasteLines || []);
        setScrapLines(data.scrapLines || []);
        setCurrentStep(data.currentStep || 1);
      }
    } catch (error) {
      console.log('ä¸‹æ›¸ããªã—');
    }
  };

  const saveDraft = async () => {
    try {
      const draftData = {
        report,
        workDetails,
        costLines,
        wasteLines,
        scrapLines,
        currentStep
      };
      await window.storage.set('logio-draft-report', JSON.stringify(draftData));
      alert('âœ… ä¸‹æ›¸ãã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    } catch (error) {
      alert('âŒ ä¸‹æ›¸ãä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  };

  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†
  const handleCancel = () => {
    if (confirm('å…¥åŠ›å†…å®¹ã‚’ç ´æ£„ã—ã¦ãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')) {
      onNavigate('home');
    }
  };

  // Step1ã®å¿…é ˆãƒã‚§ãƒƒã‚¯
  const isStep1Valid = () => {
    return report.date && report.weather && report.workCategory && report.recorder;
  };

  // åŸä¾¡æ˜ç´°è¿½åŠ 
  const addCostLine = () => {
    if (!currentCost.costCategory || !currentCost.costItem) return alert('åŸä¾¡åŒºåˆ†ã¨è²»ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„');
    
    let quantity, unitPrice, amount;
    
    if (currentCost.costCategory === 'å¤–æ³¨è²»' && currentCost.costItem === 'äººå·¥') {
      // å¤–æ³¨è²»ã®äººå·¥ã®ã¿ï¼šæ•°é‡Ã—å˜ä¾¡ã§è‡ªå‹•è¨ˆç®—
      quantity = parseFloat(currentCost.quantity) || 0;
      unitPrice = parseFloat(currentCost.unitPrice) || 0;
      
      if (quantity === 0) return alert('æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      if (unitPrice === 0) return alert('å˜ä¾¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      
      amount = quantity * unitPrice;
    } else {
      // ãã®ä»–ï¼šé‡‘é¡ã‚’ç›´æ¥å…¥åŠ›
      amount = parseFloat(currentCost.unitPrice) || 0;
      if (amount === 0) return alert('é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      
      quantity = 0;
      unitPrice = 0;
    }
    
    const newCost = {
      id: Date.now(),
      costCategory: currentCost.costCategory,
      costItem: currentCost.costItem,
      quantity: quantity,
      unitPrice: unitPrice,
      amount: amount
    };
    
    setCostLines([...costLines, newCost]);
    setCurrentCost({ costCategory: '', costItem: '', quantity: '', unitPrice: '' });
  };

  // å»ƒæ£„ç‰©æ˜ç´°è¿½åŠ 
  const addWasteLine = () => {
    if (!currentWaste.wasteType) return alert('å»ƒæ£„ç‰©ç¨®é¡ã‚’é¸æŠã—ã¦ãã ã•ã„');
    
    const finalDisposalSite = currentWaste.disposalSite === 'ãã®ä»–ï¼ˆç›´æ¥å…¥åŠ›ï¼‰' 
      ? customDisposalSite 
      : currentWaste.disposalSite;
    
    if (!finalDisposalSite) return alert('å‡¦åˆ†å…ˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    
    const quantity = parseFloat(currentWaste.quantity) || 0;
    const unitPrice = parseFloat(currentWaste.unitDisposalCost) || 0;
    
    if (quantity === 0) return alert('æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    if (unitPrice === 0) return alert('å˜ä¾¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    
    const amount = quantity * unitPrice;
    
    const newWaste = { 
      id: Date.now(), 
      wasteType: currentWaste.wasteType,
      disposalSite: finalDisposalSite,
      manifestNumber: currentWaste.manifestNumber,
      quantity: quantity,
      unitDisposalCost: unitPrice,
      disposalCost: amount
    };
    setWasteLines([...wasteLines, newWaste]);
    setCurrentWaste({ wasteType: '', disposalSite: '', manifestNumber: '', quantity: '', unitDisposalCost: '' });
    setCustomDisposalSite('');
  };

  // ã‚¹ã‚¯ãƒ©ãƒƒãƒ—æ˜ç´°è¿½åŠ 
  const addScrapLine = () => {
    if (!currentScrap.scrapType) return alert('ã‚¹ã‚¯ãƒ©ãƒƒãƒ—ç¨®é¡ã‚’é¸æŠã—ã¦ãã ã•ã„');
    if (!currentScrap.buyer) return alert('è²·å–æ¥­è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
    
    const quantity = parseFloat(currentScrap.quantity) || 0;
    const unitPrice = parseFloat(currentScrap.unitPrice) || 0;
    
    if (quantity === 0) return alert('æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    if (unitPrice === 0) return alert('å˜ä¾¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    
    const amount = quantity * unitPrice;
    
    const newScrap = { 
      id: Date.now(), 
      scrapType: currentScrap.scrapType,
      buyer: currentScrap.buyer,
      quantity: quantity,
      unitPrice: unitPrice,
      salesAmount: amount
    };
    setScrapLines([...scrapLines, newScrap]);
    setCurrentScrap({ scrapType: '', buyer: '', quantity: '', unitPrice: '' });
  };

  // æœ€çµ‚ä¿å­˜
  const handleSave = async () => {
    const finalReport = {
      ...report,
      ...workDetails,
      costLines,
      wasteLines,
      scrapLines
    };
    
    // ä¸‹æ›¸ãã‚’å‰Šé™¤
    try {
      await window.storage.delete('logio-draft-report');
    } catch (error) {
      console.log('ä¸‹æ›¸ãå‰Šé™¤å¤±æ•—');
    }
    
    onSave(finalReport);
  };

  const costTotal = costLines.reduce((sum, c) => sum + (c.amount || 0), 0);
  const wasteTotal = wasteLines.reduce((sum, w) => sum + (w.disposalCost || 0), 0);
  const scrapTotal = scrapLines.reduce((sum, s) => sum + (s.salesAmount || 0), 0);

  return (
    <div className="max-w-2xl mx-auto px-4 py-6 bg-black min-h-screen">
      <StepIndicator currentStep={currentStep} totalSteps={3} />

      {/* Step1: åŸºæœ¬æƒ…å ± */}
      {currentStep === 1 && (
        <div>
          <SectionHeader title="åŸºæœ¬æƒ…å ± / Basic Info" />
          
          <div className="mb-4">
            <label className="block text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-2">
              ä½œæ¥­æ—¥ / Date <span className="text-red-500">*</span>
            </label>
            <input 
              type="date" 
              value={report.date} 
              onChange={(e) => setReport({...report, date: e.target.value})} 
              className="w-full px-4 py-3 bg-gray-800 border border-gray-700 text-white rounded-md focus:outline-none focus:border-blue-500" 
            />
          </div>

          <Select 
            label="å¤©å€™" 
            labelEn="Weather" 
            options={MASTER_DATA.weather} 
            value={report.weather} 
            onChange={(val) => setReport({...report, weather: val})} 
            required 
          />
          
          <Select 
            label="ä½œæ¥­åŒºåˆ†" 
            labelEn="Work Category" 
            options={MASTER_DATA.workCategories} 
            value={report.workCategory} 
            onChange={(val) => setReport({...report, workCategory: val})} 
            required 
          />
          
          <Select 
            label="è¨˜å…¥è€…" 
            labelEn="Recorder" 
            options={MASTER_DATA.employees} 
            value={report.recorder} 
            onChange={(val) => setReport({...report, recorder: val})} 
            required 
          />

          {/* ä¸‹éƒ¨å›ºå®šãƒãƒ¼ */}
          <div className="fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-700 px-4 py-3 pb-safe md:left-64">
            <div className="max-w-2xl mx-auto grid grid-cols-2 gap-3">
              <button
                onClick={handleCancel}
                className="py-3 px-4 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg transition-colors font-medium text-sm"
              >
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
              </button>
              <button 
                onClick={() => setCurrentStep(2)} 
                disabled={!isStep1Valid()}
                className="py-3 px-4 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 disabled:text-gray-500 text-white rounded-lg transition-colors font-medium text-sm"
              >
                æ¬¡ã¸
              </button>
            </div>
          </div>
          {/* ä¸‹éƒ¨ãƒãƒ¼åˆ†ã®ã‚¹ãƒšãƒ¼ã‚¹ç¢ºä¿ */}
          <div className="h-20"></div>
        </div>
      )}

      {/* Step2: ä½œæ¥­å†…å®¹ãƒ»äººå“¡ãƒ»ç¨¼åƒ */}
      {currentStep === 2 && (
        <div>
          <SectionHeader title="ä½œæ¥­å†…å®¹ãƒ»äººå“¡ãƒ»ç¨¼åƒ / Work Details" />
          
          <TextArea 
            label="ä½œæ¥­å†…å®¹" 
            labelEn="Work Details" 
            value={workDetails.workContent} 
            onChange={(val) => setWorkDetails({...workDetails, workContent: val})} 
            placeholder="æœ¬æ—¥ã®ä½œæ¥­å†…å®¹ã‚’å…¥åŠ›..."
            rows={4}
          />
          
          {/* ä½œæ¥­æ™‚é–“ï¼ˆ10åˆ†å˜ä½ã‚»ãƒ¬ã‚¯ãƒˆï¼‰ */}
          <div className="mb-6">
            <label className="block text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-2">
              ä½œæ¥­æ™‚é–“ / Working Hours
            </label>
            <select
              value={minutesToTime(workDetails.workingMinutes)}
              onChange={(e) => setWorkDetails({...workDetails, workingMinutes: timeToMinutes(e.target.value)})}
              className="w-full px-4 py-3 bg-gray-900/50 border border-gray-700 text-white text-base font-medium rounded-md focus:outline-none focus:border-blue-500"
            >
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              {MASTER_DATA.workingHoursOptions.map((time) => (
                <option key={time} value={time}>{time}</option>
              ))}
            </select>
          </div>
          
          {/* è‡ªç¤¾ä½œæ¥­å“¡åé¸æŠ */}
          <MultiSelectDropdown 
            label="è‡ªç¤¾ä½œæ¥­å“¡" 
            labelEn="In-House Workers" 
            options={MASTER_DATA.inHouseWorkers} 
            selected={workDetails.inHouseWorkerNames} 
            onChange={handleWorkerNamesChange} 
          />
          
          {/* è»Šç¨®é¸æŠ */}
          <Select 
            label="è»Šç¨®" 
            labelEn="Vehicle Type" 
            options={MASTER_DATA.vehicles} 
            value={workDetails.vehicleType} 
            onChange={(val) => setWorkDetails({...workDetails, vehicleType: val, vehicleNumber: ''})} 
            placeholder="é¸æŠã—ã¦ãã ã•ã„"
          />
          
          {/* è»Šç•ªé¸æŠï¼ˆè»Šç¨®é¸æŠå¾Œã®ã¿è¡¨ç¤ºï¼‰ */}
          {workDetails.vehicleType && (
            <Select 
              label="è»Šç•ª" 
              labelEn="Vehicle No." 
              options={MASTER_DATA.vehicleNumbers} 
              value={workDetails.vehicleNumber} 
              onChange={(val) => setWorkDetails({...workDetails, vehicleNumber: val})} 
              placeholder="é¸æŠã—ã¦ãã ã•ã„"
            />
          )}
          
          {/* ä½¿ç”¨é‡æ©Ÿ */}
          <MultiSelectDropdown 
            label="ä½¿ç”¨é‡æ©Ÿ" 
            labelEn="Heavy Machinery" 
            options={MASTER_DATA.heavyMachinery} 
            selected={workDetails.heavyMachinery} 
            onChange={(val) => setWorkDetails({...workDetails, heavyMachinery: val})} 
          />

          {/* ä¸‹éƒ¨å›ºå®šãƒãƒ¼ */}
          <div className="fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-700 px-4 py-3 pb-safe md:left-64">
            <div className="max-w-2xl mx-auto">
              <div className="grid grid-cols-3 gap-2 mb-2">
                <button
                  onClick={() => setCurrentStep(1)}
                  className="py-3 px-3 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg transition-colors font-medium text-sm"
                >
                  â† æˆ»ã‚‹
                </button>
                <button
                  onClick={handleCancel}
                  className="py-3 px-3 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg transition-colors font-medium text-sm"
                >
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button
                  onClick={() => setCurrentStep(3)}
                  className="py-3 px-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium text-sm"
                >
                  æ¬¡ã¸ â†’
                </button>
              </div>
              <button
                onClick={saveDraft}
                className="w-full py-2 px-4 text-gray-400 hover:text-gray-300 text-xs font-medium transition-colors"
              >
                ä¸‹æ›¸ãä¿å­˜
              </button>
            </div>
          </div>
          {/* ä¸‹éƒ¨ãƒãƒ¼åˆ†ã®ã‚¹ãƒšãƒ¼ã‚¹ç¢ºä¿ */}
          <div className="h-28"></div>
        </div>
      )}

      {/* Step3: åŸä¾¡ãƒ»å»ƒæ£„ç‰©ãƒ»ã‚¹ã‚¯ãƒ©ãƒƒãƒ— */}
      {currentStep === 3 && (
        <div>
          <SectionHeader title="åŸä¾¡ãƒ»å»ƒæ£„ç‰©ãƒ»ã‚¹ã‚¯ãƒ©ãƒƒãƒ— / Cost Details" />
          
          <p className="text-xs text-gray-400 mb-6">â€» åŸä¾¡ãƒ»å»ƒæ£„ç‰©ãƒ»ã‚¹ã‚¯ãƒ©ãƒƒãƒ—ãŒãªã„å ´åˆã¯ãã®ã¾ã¾ä¿å­˜ã§ãã¾ã™</p>

          {/* åŸä¾¡æ˜ç´° */}
          <div className="mb-6">
            <h3 className="text-sm font-semibold text-white mb-4 uppercase tracking-wider">åŸä¾¡æ˜ç´° / Cost Lines</h3>
            
            <div className="bg-gray-900/50 rounded-md p-4 mb-4">
              <Select 
                label="åŸä¾¡åŒºåˆ†" 
                labelEn="Category" 
                options={Object.keys(MASTER_DATA.costCategories)} 
                value={currentCost.costCategory} 
                onChange={(val) => setCurrentCost({...currentCost, costCategory: val, costItem: '', quantity: '', unitPrice: ''})} 
              />
              {currentCost.costCategory && (
                <Select 
                  label="è²»ç›®" 
                  labelEn="Item" 
                  options={MASTER_DATA.costCategories[currentCost.costCategory]} 
                  value={currentCost.costItem} 
                  onChange={(val) => setCurrentCost({...currentCost, costItem: val, quantity: '', unitPrice: ''})} 
                />
              )}
              
              {currentCost.costItem && (
                <>
                  {/* å¤–æ³¨è²»ã®ã€Œäººå·¥ã€ã®ã¿æ•°é‡Ã—å˜ä¾¡ã§è‡ªå‹•è¨ˆç®— */}
                  {currentCost.costCategory === 'å¤–æ³¨è²»' && currentCost.costItem === 'äººå·¥' ? (
                    <>
                      <NumericInput
                        label="æ•°é‡"
                        labelEn="Quantity"
                        value={currentCost.quantity}
                        onChange={(val) => setCurrentCost({...currentCost, quantity: val})}
                        unit="äººå·¥"
                      />
                      
                      <AmountInput
                        label="å˜ä¾¡"
                        labelEn="Unit Price"
                        value={currentCost.unitPrice}
                        onChange={(val) => setCurrentCost({...currentCost, unitPrice: val})}
                      />
                      
                      <div className="bg-gray-800/50 rounded-md p-4 mb-4">
                        <p className="text-gray-400 text-xs mb-1">é‡‘é¡ / Amountï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</p>
                        <p className="text-white text-3xl font-semibold tabular-nums" style={amountStrokeStyle}>
                          Â¥{formatCurrency((parseFloat(currentCost.quantity) || 0) * (parseFloat(currentCost.unitPrice) || 0))}
                        </p>
                        {currentCost.quantity && currentCost.unitPrice && (
                          <p className="text-gray-500 text-xs mt-1">
                            {currentCost.quantity}äººå·¥ Ã— Â¥{formatCurrency(parseFloat(currentCost.unitPrice))}
                          </p>
                        )}
                      </div>
                    </>
                  ) : (
                    /* ãã®ä»–ã®åŸä¾¡ï¼šé‡‘é¡ã®ã¿å…¥åŠ› */
                    <AmountInput
                      label="é‡‘é¡"
                      labelEn="Amount"
                      value={currentCost.unitPrice}
                      onChange={(val) => setCurrentCost({...currentCost, unitPrice: val})}
                    />
                  )}
                </>
              )}
              
              {currentCost.costItem && (
                <button
                  onClick={addCostLine}
                  className="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium"
                >
                  ï¼‹ åŸä¾¡ã‚’è¿½åŠ 
                </button>
              )}
            </div>
            
            {/* ç™»éŒ²æ¸ˆã¿åŸä¾¡æ˜ç´°ï¼ˆè¡Œãƒªã‚¹ãƒˆè¡¨ç¤ºï¼‰ */}
            {costLines.length > 0 && (
              <div>
                <div className="flex justify-between items-center mb-2">
                  <p className="text-xs font-medium text-gray-400">ç™»éŒ²æ¸ˆã¿: {costLines.length}ä»¶</p>
                  <p className="text-sm font-semibold text-white tabular-nums" style={amountStrokeStyle}>åˆè¨ˆ: Â¥{formatCurrency(costTotal)}</p>
                </div>
                <div className="space-y-1">
                  {costLines.map(cost => (
                    <div key={cost.id} className="flex items-center gap-3 bg-gray-900/50 rounded-md p-3 hover:bg-gray-900/70 transition-colors">
                      <div className="flex-1 min-w-0">
                        <p className="text-white text-sm font-medium truncate">{cost.costCategory} - {cost.costItem}</p>
                        {cost.costCategory === 'å¤–æ³¨è²»' && cost.costItem === 'äººå·¥' && cost.quantity > 0 && (
                          <p className="text-gray-500 text-xs">
                            {cost.quantity}äººå·¥ Ã— Â¥{formatCurrency(cost.unitPrice)}
                          </p>
                        )}
                      </div>
                      <p className="text-white text-lg font-semibold tabular-nums" style={amountStrokeStyle}>Â¥{formatCurrency(cost.amount)}</p>
                      <button
                        onClick={() => setCostLines(costLines.filter(c => c.id !== cost.id))}
                        className="p-2 text-red-400 hover:text-red-300 hover:bg-gray-800 rounded-lg transition-colors"
                      >
                        <Trash2 className="w-5 h-5" />
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>

          {/* å»ƒæ£„ç‰©æ˜ç´° */}
          <div className="mb-6">
            <h3 className="text-sm font-semibold text-white mb-4 uppercase tracking-wider">å»ƒæ£„ç‰©æ˜ç´° / Waste Lines</h3>
            
            <div className="bg-gray-900/50 rounded-md p-4 mb-4">
              <Select 
                label="å»ƒæ£„ç‰©ç¨®é¡" 
                labelEn="Type" 
                options={MASTER_DATA.wasteTypes} 
                value={currentWaste.wasteType} 
                onChange={(val) => setCurrentWaste({...currentWaste, wasteType: val})} 
              />
              <Select 
                label="å‡¦åˆ†å…ˆ" 
                labelEn="Disposal Site" 
                options={MASTER_DATA.disposalSites} 
                value={currentWaste.disposalSite} 
                onChange={(val) => setCurrentWaste({...currentWaste, disposalSite: val})} 
              />

              {currentWaste.disposalSite === 'ãã®ä»–ï¼ˆç›´æ¥å…¥åŠ›ï¼‰' && (
                <TextInput
                  label="å‡¦åˆ†å…ˆåã‚’å…¥åŠ›"
                  labelEn="Custom Site"
                  value={customDisposalSite}
                  onChange={setCustomDisposalSite}
                  placeholder="å‡¦åˆ†å…ˆå"
                />
              )}

              <TextInput 
                label="ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆä¼ç¥¨ç•ªå·ï¼ˆæ¨å¥¨ï¼‰" 
                labelEn="Manifest No." 
                value={currentWaste.manifestNumber} 
                onChange={(val) => setCurrentWaste({...currentWaste, manifestNumber: val})} 
                placeholder="11-0012345" 
              />
              
              <NumericInput
                label="æ•°é‡"
                labelEn="Quantity"
                value={currentWaste.quantity}
                onChange={(val) => setCurrentWaste({...currentWaste, quantity: val})}
                unit="ã¥"
              />
              
              <AmountInput
                label="å˜ä¾¡"
                labelEn="Unit Price"
                value={currentWaste.unitDisposalCost}
                onChange={(val) => setCurrentWaste({...currentWaste, unitDisposalCost: val})}
              />
              
              <div className="bg-gray-800/50 rounded-md p-4 mb-4">
                <p className="text-gray-400 text-xs mb-1">å‡¦åˆ†è²» / Disposal Costï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</p>
                <p className="text-white text-3xl font-semibold tabular-nums" style={amountStrokeStyle}>
                  Â¥{formatCurrency((parseFloat(currentWaste.quantity) || 0) * (parseFloat(currentWaste.unitDisposalCost) || 0))}
                </p>
                {currentWaste.quantity && currentWaste.unitDisposalCost && (
                  <p className="text-gray-500 text-xs mt-1">
                    {currentWaste.quantity}ã¥ Ã— Â¥{formatCurrency(parseFloat(currentWaste.unitDisposalCost))}
                  </p>
                )}
              </div>
              
              <button
                onClick={addWasteLine}
                className="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium"
              >
                ï¼‹ å»ƒæ£„ç‰©ã‚’è¿½åŠ 
              </button>
            </div>
            
            {/* ç™»éŒ²æ¸ˆã¿å»ƒæ£„ç‰©æ˜ç´°ï¼ˆè¡Œãƒªã‚¹ãƒˆè¡¨ç¤ºï¼‰ */}
            {wasteLines.length > 0 && (
              <div>
                <div className="flex justify-between items-center mb-2">
                  <p className="text-xs font-medium text-gray-400">ç™»éŒ²æ¸ˆã¿: {wasteLines.length}ä»¶</p>
                  <p className="text-sm font-semibold text-white tabular-nums" style={amountStrokeStyle}>åˆè¨ˆ: Â¥{formatCurrency(wasteTotal)}</p>
                </div>
                <div className="space-y-1">
                  {wasteLines.map(waste => (
                    <div key={waste.id} className="flex items-center gap-3 bg-gray-900/50 rounded-md p-3 hover:bg-gray-900/70 transition-colors">
                      <div className="flex-1 min-w-0">
                        <p className="text-white text-sm font-medium truncate">{waste.wasteType} - {waste.disposalSite}</p>
                        <div className="flex items-center gap-2 text-xs text-gray-500">
                          {waste.quantity > 0 && waste.unitDisposalCost > 0 && (
                            <span>{waste.quantity}ã¥ Ã— Â¥{formatCurrency(waste.unitDisposalCost)}</span>
                          )}
                          {waste.manifestNumber && <span className="text-gray-600">â€¢ ä¼ç¥¨: {waste.manifestNumber}</span>}
                        </div>
                      </div>
                      <p className="text-white text-lg font-semibold tabular-nums" style={amountStrokeStyle}>Â¥{formatCurrency(waste.disposalCost)}</p>
                      <button
                        onClick={() => setWasteLines(wasteLines.filter(w => w.id !== waste.id))}
                        className="p-2 text-red-400 hover:text-red-300 hover:bg-gray-800 rounded-lg transition-colors"
                      >
                        <Trash2 className="w-5 h-5" />
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>

          {/* ã‚¹ã‚¯ãƒ©ãƒƒãƒ—æ˜ç´° */}
          <div className="mb-6">
            <h3 className="text-sm font-semibold text-white mb-4 uppercase tracking-wider">ã‚¹ã‚¯ãƒ©ãƒƒãƒ—æ˜ç´° / Scrap Lines</h3>
            
            <div className="bg-gray-900/50 rounded-md p-4 mb-4">
              <Select 
                label="ã‚¹ã‚¯ãƒ©ãƒƒãƒ—ç¨®é¡" 
                labelEn="Type" 
                options={MASTER_DATA.scrapTypes} 
                value={currentScrap.scrapType} 
                onChange={(val) => setCurrentScrap({...currentScrap, scrapType: val})} 
              />
              <Select 
                label="è²·å–æ¥­è€…" 
                labelEn="Buyer" 
                options={MASTER_DATA.buyers} 
                value={currentScrap.buyer} 
                onChange={(val) => setCurrentScrap({...currentScrap, buyer: val})} 
              />
              
              <NumericInput
                label="æ•°é‡"
                labelEn="Quantity"
                value={currentScrap.quantity}
                onChange={(val) => setCurrentScrap({...currentScrap, quantity: val})}
                unit="kg"
              />
              
              <AmountInput
                label="å˜ä¾¡"
                labelEn="Unit Price"
                value={currentScrap.unitPrice}
                onChange={(val) => setCurrentScrap({...currentScrap, unitPrice: val})}
              />
              
              <div className="bg-gray-800/50 rounded-md p-4 mb-4">
                <p className="text-gray-400 text-xs mb-1">å£²å´é¡ / Sales Amountï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</p>
                <p className="text-white text-3xl font-semibold tabular-nums" style={amountStrokeStyle}>
                  Â¥{formatCurrency((parseFloat(currentScrap.quantity) || 0) * (parseFloat(currentScrap.unitPrice) || 0))}
                </p>
                {currentScrap.quantity && currentScrap.unitPrice && (
                  <p className="text-gray-500 text-xs mt-1">
                    {currentScrap.quantity}kg Ã— Â¥{formatCurrency(parseFloat(currentScrap.unitPrice))}
                  </p>
                )}
              </div>
              
              <button
                onClick={addScrapLine}
                className="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium"
              >
                ï¼‹ ã‚¹ã‚¯ãƒ©ãƒƒãƒ—ã‚’è¿½åŠ 
              </button>
            </div>
            
            {/* ç™»éŒ²æ¸ˆã¿ã‚¹ã‚¯ãƒ©ãƒƒãƒ—æ˜ç´°ï¼ˆè¡Œãƒªã‚¹ãƒˆè¡¨ç¤ºï¼‰ */}
            {scrapLines.length > 0 && (
              <div>
                <div className="flex justify-between items-center mb-2">
                  <p className="text-xs font-medium text-gray-400">ç™»éŒ²æ¸ˆã¿: {scrapLines.length}ä»¶</p>
                  <p className="text-sm font-semibold text-white tabular-nums" style={amountStrokeStyle}>åˆè¨ˆ: Â¥{formatCurrency(scrapTotal)}</p>
                </div>
                <div className="space-y-1">
                  {scrapLines.map(scrap => (
                    <div key={scrap.id} className="flex items-center gap-3 bg-gray-900/50 rounded-md p-3 hover:bg-gray-900/70 transition-colors">
                      <div className="flex-1 min-w-0">
                        <p className="text-white text-sm font-medium truncate">{scrap.scrapType} - {scrap.buyer}</p>
                        {scrap.quantity > 0 && scrap.unitPrice > 0 && (
                          <p className="text-gray-500 text-xs">
                            {scrap.quantity}kg Ã— Â¥{formatCurrency(scrap.unitPrice)}
                          </p>
                        )}
                      </div>
                      <p className="text-white text-lg font-semibold tabular-nums" style={amountStrokeStyle}>Â¥{formatCurrency(scrap.salesAmount)}</p>
                      <button
                        onClick={() => setScrapLines(scrapLines.filter(s => s.id !== scrap.id))}
                        className="p-2 text-red-400 hover:text-red-300 hover:bg-gray-800 rounded-lg transition-colors"
                      >
                        <Trash2 className="w-5 h-5" />
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>

          {/* ä¸‹éƒ¨å›ºå®šãƒãƒ¼ */}
          <div className="fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-700 px-4 py-3 pb-safe md:left-64">
            <div className="max-w-2xl mx-auto">
              <div className="grid grid-cols-3 gap-2 mb-2">
                <button
                  onClick={() => setCurrentStep(2)}
                  className="py-3 px-3 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg transition-colors font-medium text-sm"
                >
                  â† æˆ»ã‚‹
                </button>
                <button
                  onClick={handleCancel}
                  className="py-3 px-3 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg transition-colors font-medium text-sm"
                >
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button
                  onClick={handleSave}
                  className="py-3 px-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium text-sm"
                >
                  ä¿å­˜
                </button>
              </div>
              <button
                onClick={saveDraft}
                className="w-full py-2 px-4 text-gray-400 hover:text-gray-300 text-xs font-medium transition-colors"
              >
                ä¸‹æ›¸ãä¿å­˜
              </button>
            </div>
          </div>
          
          {/* ä¸‹éƒ¨ãƒãƒ¼åˆ†ã®ã‚¹ãƒšãƒ¼ã‚¹ç¢ºä¿ */}
          <div className="h-28"></div>
        </div>
      )}
    </div>
  );
}

function ReportListPage({ reports, onDelete, onNavigate }) {
  const [filterMonth, setFilterMonth] = useState('');
  const [filterCategory, setFilterCategory] = useState('');

  const filteredReports = reports.filter(r => {
    if (filterMonth && !r.date.startsWith(filterMonth)) return false;
    if (filterCategory && r.workCategory !== filterCategory) return false;
    return true;
  });

  const months = [...new Set(reports.map(r => r.date.substring(0, 7)))].sort().reverse();

  return (
    <div className="max-w-2xl mx-auto px-6 py-8">
      {/* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */}
      <div className="mb-4">
        <button
          onClick={() => onNavigate('home')}
          className="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg transition-colors font-medium text-sm flex items-center gap-2"
        >
          <X className="w-4 h-4" />
          é–‰ã˜ã‚‹
        </button>
      </div>
      
      <div className="grid grid-cols-2 gap-4 mb-6">
        <Select label="æœˆ" labelEn="Month" options={months} value={filterMonth} onChange={setFilterMonth} placeholder="å…¨æœŸé–“" />
        <Select label="ä½œæ¥­åŒºåˆ†" labelEn="Category" options={MASTER_DATA.workCategories} value={filterCategory} onChange={setFilterCategory} placeholder="å…¨ä½œæ¥­" />
      </div>

      <p className="text-sm text-gray-600 mb-4">å…¨ {filteredReports.length}ä»¶</p>

      {filteredReports.sort((a, b) => new Date(b.date) - new Date(a.date)).map(report => (
        <ReportAccordion key={report.id} report={report} onDelete={() => onDelete(report.id)} />
      ))}

      {filteredReports.length === 0 && <p className="text-center text-gray-400 py-12">è©²å½“ã™ã‚‹æ—¥å ±ãŒã‚ã‚Šã¾ã›ã‚“</p>}
    </div>
  );
}

function ReportAccordion({ report, onDelete }) {
  const [isOpen, setIsOpen] = useState(false);
  
  // åˆ†ã‚’æ™‚:åˆ†ã«å¤‰æ›
  const minutesToTimeDisplay = (minutes) => {
    if (!minutes) return null;
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    return `${h}æ™‚é–“${m > 0 ? m + 'åˆ†' : ''}`;
  };

  return (
    <div className="border-b-2 border-gray-200">
      <button onClick={() => setIsOpen(!isOpen)} className="w-full px-4 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors">
        <div className="text-left flex-1">
          <p className="font-bold text-base">{report.date} ({getDayOfWeek(report.date)}) {report.weather}</p>
          <p className="text-sm text-gray-600">
            {report.workCategory}
            {report.workingMinutes > 0 && <span> / {minutesToTimeDisplay(report.workingMinutes)}</span>}
            {report.inHouseWorkers > 0 && <span> / ä½œæ¥­å“¡{report.inHouseWorkers}å</span>}
          </p>
        </div>
        <span className="text-2xl text-gray-400 ml-4">{isOpen ? <ChevronUp className="w-6 h-6" /> : <ChevronDown className="w-6 h-6" />}</span>
      </button>

      {isOpen && (
        <div className="px-4 py-6 bg-gray-50 border-t border-gray-200">
          {/* ä½œæ¥­æ™‚é–“ãƒ»ä½œæ¥­å“¡ */}
          {(report.workingMinutes > 0 || report.inHouseWorkerNames?.length > 0) && (
            <div className="mb-4">
              {report.workingMinutes > 0 && (
                <div className="mb-2">
                  <p className="text-xs font-semibold text-gray-500 uppercase mb-1">ä½œæ¥­æ™‚é–“:</p>
                  <p className="text-sm">{minutesToTimeDisplay(report.workingMinutes)}</p>
                </div>
              )}
              {report.inHouseWorkerNames && report.inHouseWorkerNames.length > 0 && (
                <div className="mb-2">
                  <p className="text-xs font-semibold text-gray-500 uppercase mb-1">è‡ªç¤¾ä½œæ¥­å“¡ ({report.inHouseWorkerNames.length}å):</p>
                  <p className="text-sm">{report.inHouseWorkerNames.join('ã€')}</p>
                </div>
              )}
            </div>
          )}
          
          <div className="mb-4">
            <p className="text-xs font-semibold text-gray-500 uppercase mb-1">ä½œæ¥­å†…å®¹:</p>
            <p className="text-sm">{report.workContent || 'ãªã—'}</p>
          </div>

          {report.costLines && report.costLines.length > 0 && (
            <div className="mb-4">
              <p className="text-xs font-semibold text-gray-500 uppercase mb-2">åŸä¾¡: {report.costLines.length}ä»¶ / Â¥{formatCurrency(report.costLines.reduce((s, c) => s + c.amount, 0))}</p>
              {report.costLines.map((cost, idx) => (
                <p key={idx} className="text-sm ml-2">ãƒ»{cost.costCategory} - {cost.costItem} Â¥{formatCurrency(cost.amount)}</p>
              ))}
            </div>
          )}

          {report.wasteLines && report.wasteLines.length > 0 && (
            <div className="mb-4">
              <p className="text-xs font-semibold text-gray-500 uppercase mb-2">å»ƒæ£„ç‰©: {report.wasteLines.length}ä»¶ / Â¥{formatCurrency(report.wasteLines.reduce((s, w) => s + w.disposalCost, 0))}</p>
              {report.wasteLines.map((waste, idx) => (
                <div key={idx} className="text-sm ml-2">
                  <p>ãƒ»{waste.wasteType} {waste.quantity}ã¥ - {waste.disposalSite}</p>
                  {waste.manifestNumber && <p className="text-xs text-gray-500 ml-4">ä¼ç¥¨: {waste.manifestNumber}</p>}
                </div>
              ))}
            </div>
          )}

          {report.scrapLines && report.scrapLines.length > 0 && (
            <div className="mb-4">
              <p className="text-xs font-semibold text-gray-500 uppercase mb-2">ã‚¹ã‚¯ãƒ©ãƒƒãƒ—: {report.scrapLines.length}ä»¶ / Â¥{formatCurrency(report.scrapLines.reduce((s, sc) => s + sc.salesAmount, 0))}</p>
              {report.scrapLines.map((scrap, idx) => (
                <p key={idx} className="text-sm ml-2">ãƒ»{scrap.scrapType} {scrap.quantity}kg - {scrap.buyer}</p>
              ))}
            </div>
          )}

          <div className="text-sm text-gray-600">
            {report.vehicleType && <p>ä½¿ç”¨è»Šä¸¡: {report.vehicleType}{report.vehicleNumber && ` (${report.vehicleNumber})`}</p>}
            <p>ä½¿ç”¨é‡æ©Ÿ: {report.heavyMachinery?.join(', ') || 'ãªã—'}</p>
            <p>è¨˜å…¥è€…: {report.recorder}</p>
          </div>

          <div className="mt-4">
            <Button variant="danger" onClick={onDelete} icon={Trash2}>å‰Šé™¤</Button>
          </div>
        </div>
      )}
    </div>
  );
}

function AnalysisPage({ reports, totals, projectInfo, onNavigate }) {
  // åŠ´å‹™è²»ã‚’é™¤å¤–ã—ã€æ—¢å­˜ã®åŠ´å‹™è²»ãƒ‡ãƒ¼ã‚¿ã¯çµŒè²»ã«é›†ç´„
  const costByCategory = { 'ææ–™è²»': 0, 'å¤–æ³¨è²»': 0, 'çµŒè²»': 0 };

  reports.forEach(r => {
    r.costLines?.forEach(c => {
      // åŠ´å‹™è²»ã¯çµŒè²»ã¨ã—ã¦é›†è¨ˆ
      const category = c.costCategory === 'åŠ´å‹™è²»' ? 'çµŒè²»' : c.costCategory;
      if (costByCategory[category] !== undefined) {
        costByCategory[category] = (costByCategory[category] || 0) + c.amount;
      } else {
        // æœªå®šç¾©ã‚«ãƒ†ã‚´ãƒªã¯çµŒè²»æ‰±ã„
        costByCategory['çµŒè²»'] += c.amount;
      }
    });
    r.wasteLines?.forEach(w => {
      costByCategory['çµŒè²»'] += w.disposalCost;
    });
  });

  const pieData = Object.keys(costByCategory).map(key => ({
    name: key,
    value: costByCategory[key]
  })).filter(d => d.value > 0);

  const COLORS = ['#1E3A8A', '#3B82F6', '#60A5FA'];

  const monthlyData = {};
  reports.forEach(r => {
    const month = r.date.substring(0, 7);
    if (!monthlyData[month]) monthlyData[month] = 0;
    r.costLines?.forEach(c => monthlyData[month] += c.amount);
    r.wasteLines?.forEach(w => monthlyData[month] += w.disposalCost);
  });

  const barData = Object.keys(monthlyData).sort().map(month => ({
    month: month.substring(5),
    cost: Math.round(monthlyData[month] / 10000)
  }));

  // åŸä¾¡ç‡è¨ˆç®—
  const costRatio = totals.totalRevenue > 0 ? ((totals.accumulatedCost / totals.totalRevenue) * 100).toFixed(1) : '0.0';
  const costRatioNum = parseFloat(costRatio);
  let costRatioStatus = 'ä½™è£•ã‚ã‚Š';
  let costRatioColor = 'text-blue-400';
  if (costRatioNum >= 85) {
    costRatioStatus = 'è¦è­¦æˆ’';
    costRatioColor = 'text-red-400';
  } else if (costRatioNum >= 70) {
    costRatioStatus = 'æ³¨æ„';
    costRatioColor = 'text-gray-400';
  }

  return (
    <div className="max-w-2xl mx-auto px-4 py-6 bg-black min-h-screen">
      {/* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */}
      <div className="mb-4">
        <button
          onClick={() => onNavigate('home')}
          className="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg transition-colors font-medium text-sm flex items-center gap-2"
        >
          <X className="w-4 h-4" />
          é–‰ã˜ã‚‹
        </button>
      </div>
      
      {/* ç¾å ´æƒ…å ±ã‚«ãƒ¼ãƒ‰ */}
      {projectInfo?.projectName && (
        <div className="mb-6 px-4 py-4 bg-gray-900/50 border border-gray-800 rounded-md">
          <div className="text-white text-lg font-bold leading-relaxed mb-2">
            {projectInfo.projectName}
          </div>
          {projectInfo.projectNumber && (
            <div className="text-gray-500 text-xs font-medium tracking-wide">
              PROJECT NO.: {projectInfo.projectNumber}
            </div>
          )}
        </div>
      )}
      
      {/* ãƒ¡ã‚¤ãƒ³KPIã‚µãƒãƒªãƒ¼ */}
      <div className="mb-6">
        <SectionHeader title="è²¡å‹™ã‚µãƒãƒªãƒ¼ / Financial Summary" />
        <div className="bg-gray-900/50 rounded-md p-5 space-y-3">
          <div className="flex justify-between items-center py-2 border-b border-gray-800">
            <span className="text-xs font-medium text-gray-400">å£²ä¸Š / Revenue</span>
            <span className="text-lg font-semibold text-white tabular-nums" style={amountStrokeStyle}>Â¥{formatCurrency(totals.totalRevenue)}</span>
          </div>
          <div className="flex justify-between items-center py-2 border-b border-gray-800">
            <span className="text-xs font-medium text-gray-400">åŸä¾¡ / Cost</span>
            <span className="text-lg font-semibold text-red-400/50 tabular-nums" style={amountStrokeStyle}>Â¥{formatCurrency(totals.accumulatedCost)}</span>
          </div>
          {totals.accumulatedScrap > 0 && (
            <div className="flex justify-between items-center py-2 border-b border-gray-800">
              <span className="text-xs font-medium text-gray-400">ã‚¹ã‚¯ãƒ©ãƒƒãƒ— / Scrap</span>
              <span className="text-lg font-semibold text-white tabular-nums" style={amountStrokeStyle}>Â¥{formatCurrency(totals.accumulatedScrap)}</span>
            </div>
          )}
          <div className="flex justify-between items-center py-2 border-b-2 border-gray-700">
            <span className="text-xs font-medium text-gray-400">ç²—åˆ© / Profit</span>
            <span className={`text-lg font-semibold tabular-nums ${totals.grossProfit >= 0 ? 'text-blue-400/60' : 'text-red-400/50'}`} style={amountStrokeStyle}>
              Â¥{formatCurrency(totals.grossProfit)}
            </span>
          </div>
          <div className="flex justify-between items-center py-2">
            <span className="text-xs font-medium text-gray-400">ç²—åˆ©ç‡ / Margin</span>
            <div className="text-right">
              <span className="text-lg font-semibold text-white tabular-nums" style={amountStrokeStyle}>{totals.grossProfitRateContract}%</span>
              <span className="text-xs text-gray-500 ml-2">(è¾¼ã¿: {totals.grossProfitRateWithScrap}%)</span>
            </div>
          </div>
        </div>
      </div>

      {/* åŸä¾¡ç‡æŒ‡æ¨™ */}
      <div className="mb-6 bg-gray-900/50 rounded-md p-5">
        <div className="flex items-center justify-between">
          <div>
            <p className="text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-1">åŸä¾¡ç‡ / Cost Ratio</p>
            <p className={`text-4xl font-semibold ${costRatioColor} tabular-nums`} style={amountStrokeStyle}>{costRatio}%</p>
          </div>
          <div className="text-right">
            <p className="text-[10px] text-gray-500 mb-2">ç›®å®‰</p>
            <p className={`text-lg font-semibold ${costRatioColor}`}>{costRatioStatus}</p>
          </div>
        </div>
      </div>

      <SectionHeader title="åŸä¾¡æ§‹æˆæ¯” / Cost Structure" />
      
      {pieData.length > 0 ? (
        <div className="bg-gray-900/50 rounded-md p-5 mb-6">
          <ResponsiveContainer width="100%" height={300}>
            <PieChart>
              <Pie data={pieData} dataKey="value" nameKey="name" cx="50%" cy="50%" outerRadius={100} label>
                {pieData.map((entry, index) => (
                  <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                ))}
              </Pie>
              <Tooltip formatter={(value) => `Â¥${formatCurrency(value)}`} />
              <Legend />
            </PieChart>
          </ResponsiveContainer>

          <div className="mt-4 space-y-2 pt-4 border-t border-gray-800">
            {pieData.map((item, idx) => {
              const total = pieData.reduce((s, d) => s + d.value, 0);
              const percent = ((item.value / total) * 100).toFixed(1);
              return (
                <div key={idx} className="flex justify-between items-center">
                  <span className="text-xs font-medium text-gray-400">{item.name}</span>
                  <div className="text-right">
                    <span className="text-sm font-semibold text-white tabular-nums">Â¥{formatCurrency(item.value)}</span>
                    <span className="text-xs text-gray-500 ml-2">({percent}%)</span>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      ) : (
        <div className="bg-gray-900/50 rounded-md p-8">
          <p className="text-center text-gray-500 text-sm">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
        </div>
      )}

      <div className="mt-8">
        <SectionHeader title="æœˆåˆ¥åŸä¾¡æ¨ç§» / Monthly Trend" />
        
        {barData.length > 0 ? (
          <div className="bg-gray-900/50 rounded-md p-5">
            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={barData}>
                <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                <XAxis dataKey="month" stroke="#9CA3AF" />
                <YAxis label={{ value: '(ä¸‡å††)', angle: -90, position: 'insideLeft' }} stroke="#9CA3AF" />
                <Tooltip formatter={(value) => `${value}ä¸‡å††`} contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #374151' }} />
                <Bar dataKey="cost" fill="#3B82F6" />
              </BarChart>
            </ResponsiveContainer>
          </div>
        ) : (
          <div className="bg-gray-900/50 rounded-md p-8">
            <p className="text-center text-gray-500 text-sm">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
          </div>
        )}
      </div>
    </div>
  );
}

// ========== ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª ==========
export default function LOGIOApp() {
  console.log('ğŸš€ LOGIOApp: Component starting...');
  
  const [showSplash, setShowSplash] = useState(false); // ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
  const [currentPage, setCurrentPage] = useState('home');
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [showPasswordModal, setShowPasswordModal] = useState(false);
  const [password, setPassword] = useState('');
  const [passwordSuccessCallback, setPasswordSuccessCallback] = useState(null);
  
  const [sites, setSites] = useState([]);
  const [selectedSite, setSelectedSite] = useState('');
  
  console.log('ğŸ“Š LOGIOApp: State initialized', { 
    showSplash, 
    currentPage, 
    sitesCount: sites.length, 
    selectedSite 
  });
  const [projectInfo, setProjectInfo] = useState({
    projectId: '', projectNumber: '', projectName: '', client: '', workLocation: '',
    salesPerson: '', siteManager: '', startDate: '', endDate: '',
    contractAmount: '', additionalAmount: '', status: 'é€²è¡Œä¸­'
  });
  const [reports, setReports] = useState([]);

  // ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢ã‚¿ã‚¤ãƒãƒ¼ï¼ˆã‚·ãƒãƒãƒ†ã‚£ãƒƒã‚¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: 3.7s + ä½™ç™½: 0.3sï¼‰
  useEffect(() => {
    // showSplash=falseå›ºå®šãªã®ã§ã€ç„¡é§„ãªsetStateã‚’å›é¿
    if (!showSplash) return;
    const timer = setTimeout(() => {
      setShowSplash(false);
    }, 4000);
    return () => clearTimeout(timer);
  }, [showSplash]);

  useEffect(() => { loadSites(); }, []);

  const loadSites = async () => {
    try {
      const stored = await window.storage.get('logio-sites');
      if (stored?.value) {
        const loadedSites = JSON.parse(stored.value);
        
        // å„ã‚µã‚¤ãƒˆã®projectNumberã‚’å–å¾—
        const sitesWithNumbers = await Promise.all(
          loadedSites.map(async (site) => {
            try {
              const projectStored = await window.storage.get(`logio-project-${site.name}`);
              if (projectStored?.value) {
                const projectData = JSON.parse(projectStored.value);
                return { ...site, projectNumber: projectData.projectNumber || '' };
              }
            } catch (error) {
              return { ...site, projectNumber: '' };
            }
            return { ...site, projectNumber: '' };
          })
        );
        
        setSites(sitesWithNumbers);
      }
    } catch (error) { console.log('åˆå›èµ·å‹•'); }
  };

  // PROJECT NO. è‡ªå‹•æ¡ç•ªé–¢æ•°
  const generateProjectNumber = async () => {
    const currentYear = new Date().getFullYear();
    const yearPrefix = currentYear.toString();
    
    // å…¨ã‚µã‚¤ãƒˆã®projectNumberã‚’åé›†
    const allProjectNumbers = [];
    for (const site of sites) {
      try {
        const stored = await window.storage.get(`logio-project-${site.name}`);
        if (stored?.value) {
          const projectData = JSON.parse(stored.value);
          if (projectData.projectNumber) {
            allProjectNumbers.push(projectData.projectNumber);
          }
        }
      } catch (error) {
        console.log(`Failed to load project info for ${site.name}`);
      }
    }
    
    // å½“å¹´ã®projectNumberã®ã¿æŠ½å‡º
    const currentYearNumbers = allProjectNumbers
      .filter(num => num.startsWith(yearPrefix + '-'))
      .map(num => {
        const parts = num.split('-');
        return parts.length === 2 ? parseInt(parts[1], 10) : 0;
      })
      .filter(num => !isNaN(num));
    
    // æœ€å¤§é€£ç•ªã‚’å–å¾—
    const maxNumber = currentYearNumbers.length > 0 ? Math.max(...currentYearNumbers) : 0;
    
    // æ–°è¦ç•ªå·ã‚’æ¡ç•ªï¼ˆ3æ¡ã‚¼ãƒ­åŸ‹ã‚ï¼‰
    const newNumber = (maxNumber + 1).toString().padStart(3, '0');
    
    return `${yearPrefix}-${newNumber}`;
  };

  const handleAddSite = async (siteName) => {
    try {
      // PROJECT NO.ã‚’è‡ªå‹•æ¡ç•ª
      const projectNumber = await generateProjectNumber();
      
      // æ–°è¦ã‚µã‚¤ãƒˆä½œæˆï¼ˆprojectNumberã‚’å«ã‚€ï¼‰
      const newSite = {
        name: siteName,
        createdAt: new Date().toISOString(),
        status: 'é€²è¡Œä¸­',
        projectNumber: projectNumber
      };
      const updatedSites = [...sites, newSite];
      setSites(updatedSites);
      await window.storage.set('logio-sites', JSON.stringify(updatedSites));
      
      // projectInfoã‚’åˆæœŸåŒ–ã—ã¦ä¿å­˜
      const initialProjectInfo = {
        projectId: '',
        projectNumber: projectNumber,
        projectName: siteName,
        client: '',
        workLocation: '',
        salesPerson: '',
        siteManager: '',
        startDate: '',
        endDate: '',
        contractAmount: '',
        additionalAmount: '',
        status: 'é€²è¡Œä¸­'
      };
      
      await window.storage.set(`logio-project-${siteName}`, JSON.stringify(initialProjectInfo));
      
      setSelectedSite(siteName);
      setProjectInfo(initialProjectInfo);
      
      alert(`âœ… ç¾å ´ã€Œ${siteName}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ\nPROJECT NO.: ${projectNumber}`);
    } catch (error) {
      alert('âŒ ç¾å ´ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
      console.error(error);
    }
  };

  const handleDeleteSite = async (siteName) => {
    try {
      const updatedSites = sites.filter(s => s.name !== siteName);
      setSites(updatedSites);
      await window.storage.set('logio-sites', JSON.stringify(updatedSites));
      await window.storage.delete(`logio-project-${siteName}`);
      await window.storage.delete(`logio-reports-${siteName}`);
      
      // å‰Šé™¤ã•ã‚ŒãŸç¾å ´ãŒé¸æŠä¸­ã®å ´åˆã€ç¾å ´é¸æŠç”»é¢ã«æˆ»ã‚‹
      if (selectedSite === siteName) {
        setSelectedSite('');
      }
      
      alert(`âœ… ç¾å ´ã€Œ${siteName}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
    } catch (error) {
      alert('âŒ ç¾å ´ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  };

  const handleSelectSite = async (siteName) => {
    setSelectedSite(siteName);
    await loadProjectInfo(siteName);
    await loadReports(siteName);
  };

  const loadProjectInfo = async (siteName) => {
    try {
      const stored = await window.storage.get(`logio-project-${siteName}`);
      if (stored?.value) setProjectInfo(JSON.parse(stored.value));
      else setProjectInfo({
        projectId: '', projectNumber: '', projectName: '', client: '', workLocation: '',
        salesPerson: '', siteManager: '', startDate: '', endDate: '',
        contractAmount: '', additionalAmount: '', status: 'é€²è¡Œä¸­'
      });
    } catch (error) { console.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ãªã—'); }
  };

  const loadReports = async (siteName) => {
    try {
      const stored = await window.storage.get(`logio-reports-${siteName}`);
      setReports(stored?.value ? JSON.parse(stored.value) : []);
    } catch (error) { setReports([]); }
  };

  const handleSaveProject = async () => {
    if (!selectedSite) return alert('ç¾å ´ã‚’é¸æŠã—ã¦ãã ã•ã„');
    try {
      const updatedInfo = { ...projectInfo, projectId: projectInfo.projectId || generateId('P'), updatedAt: new Date().toISOString() };
      await window.storage.set(`logio-project-${selectedSite}`, JSON.stringify(updatedInfo));
      setProjectInfo(updatedInfo);
      alert('âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      setCurrentPage('home');
    } catch (error) { alert('âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
  };

  const handleSaveReport = async (reportData) => {
    if (!selectedSite) return alert('ç¾å ´ã‚’é¸æŠã—ã¦ãã ã•ã„');
    try {
      const newReport = {
        id: Date.now(),
        reportId: generateId('R'),
        projectId: projectInfo.projectId || generateId('P'),
        ...reportData,
        createdAt: new Date().toISOString()
      };
      
      const updatedReports = [...reports, newReport];
      setReports(updatedReports);
      await window.storage.set(`logio-reports-${selectedSite}`, JSON.stringify(updatedReports));
      
      alert('âœ… æ—¥å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      setCurrentPage('home');
    } catch (error) { alert('âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
  };

  const handleDeleteReport = async (reportId) => {
    if (!confirm('ã“ã®æ—¥å ±ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    try {
      const updatedReports = reports.filter(r => r.id !== reportId);
      setReports(updatedReports);
      await window.storage.set(`logio-reports-${selectedSite}`, JSON.stringify(updatedReports));
      alert('âœ… æ—¥å ±ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    } catch (error) { alert('âŒ å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
  };

  const calculateTotals = () => {
    const totalRevenue = (parseFloat(projectInfo.contractAmount) || 0) + (parseFloat(projectInfo.additionalAmount) || 0);
    let accumulatedCost = 0;
    let accumulatedScrap = 0;
    
    reports.forEach(report => {
      report.costLines?.forEach(cost => accumulatedCost += cost.amount || 0);
      report.wasteLines?.forEach(waste => accumulatedCost += waste.disposalCost || 0);
      report.scrapLines?.forEach(scrap => accumulatedScrap += scrap.salesAmount || 0);
    });
    
    // ç²—åˆ©ï¼ˆã‚¹ã‚¯ãƒ©ãƒƒãƒ—è¾¼ã¿ï¼‰
    const grossProfit = totalRevenue - accumulatedCost + accumulatedScrap;
    
    // ç²—åˆ©ç‡ï¼ˆå¥‘ç´„ãƒ™ãƒ¼ã‚¹ï¼‰= ç²—åˆ© Ã· å£²ä¸Š Ã— 100
    const grossProfitRateContract = totalRevenue > 0 ? (grossProfit / totalRevenue * 100).toFixed(1) : '0.0';
    
    // ç²—åˆ©ç‡ï¼ˆã‚¹ã‚¯ãƒ©ãƒƒãƒ—è¾¼ã¿ï¼‰= ç²—åˆ© Ã· (å£²ä¸Š + ã‚¹ã‚¯ãƒ©ãƒƒãƒ—) Ã— 100
    const totalRevenueWithScrap = totalRevenue + accumulatedScrap;
    const grossProfitRateWithScrap = totalRevenueWithScrap > 0 ? (grossProfit / totalRevenueWithScrap * 100).toFixed(1) : '0.0';
    
    return { 
      totalRevenue, 
      accumulatedCost, 
      accumulatedScrap, 
      grossProfit,                    // ç²—åˆ©ï¼ˆã‚¹ã‚¯ãƒ©ãƒƒãƒ—è¾¼ã¿ï¼‰
      grossProfitRateContract,        // ç²—åˆ©ç‡ï¼ˆå¥‘ç´„ãƒ™ãƒ¼ã‚¹ï¼‰
      grossProfitRateWithScrap        // ç²—åˆ©ç‡ï¼ˆã‚¹ã‚¯ãƒ©ãƒƒãƒ—è¾¼ã¿ï¼‰
    };
  };

  const handleNavigate = (page) => {
    if (page === 'settings') {
      setPasswordSuccessCallback(() => () => setCurrentPage('settings'));
      setShowPasswordModal(true);
      setPassword('');
    } else {
      setCurrentPage(page);
    }
  };

  const handleRequestAddSite = () => {
    console.log('ğŸ”‘ handleRequestAddSite: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã™');
    setPasswordSuccessCallback(() => () => setCurrentPage('settings'));
    setShowPasswordModal(true);
    console.log('ğŸ”‘ handleRequestAddSite: showPasswordModal =', true);
    setPassword('');
  };

  const handlePasswordSubmit = () => {
    if (password === 'face1991') {
      setShowPasswordModal(false);
      setPassword('');
      
      // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒã‚ã‚Œã°å®Ÿè¡Œã€ãªã‘ã‚Œã°è¨­å®šç”»é¢ã«é·ç§»
      if (passwordSuccessCallback) {
        passwordSuccessCallback();
        setPasswordSuccessCallback(null);
      } else {
        setCurrentPage('settings');
      }
    } else {
      alert('âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
      setPassword('');
    }
  };

  const totals = calculateTotals();

  console.log('ğŸ¨ LOGIOApp: Render decision', {
    showSplash,
    selectedSite,
    sitesCount: sites.length,
    showPasswordModal
  });

  // ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢ã‚’è¡¨ç¤º
  if (showSplash) {
    console.log('ğŸ’« LOGIOApp: Rendering SplashScreen');
    return <SplashScreen />;
  }

  // ---- ç¾å ´ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆ ----
  if (!selectedSite) {
    // è¨­å®šãƒšãƒ¼ã‚¸ã ã‘ã¯è¡¨ç¤ºè¨±å¯ï¼ˆç¾å ´è¿½åŠ ã®ãŸã‚ï¼‰
    if (currentPage === 'settings') {
      return (
        <>
          <ProjectSettingsPage
            sites={sites}
            selectedSite={selectedSite}
            projectInfo={projectInfo}
            setProjectInfo={setProjectInfo}
            onSave={handleSaveProject}
            onAddSite={handleAddSite}
            onDeleteSite={handleDeleteSite}
            onNavigate={setCurrentPage}
          />

          {showPasswordModal && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 px-4">
              <div className="bg-gray-900 p-6 max-w-md w-full rounded-lg border border-gray-700">
                <h2 className="text-xl font-bold text-white mb-4">ç®¡ç†è€…èªè¨¼</h2>
                <p className="text-sm text-gray-400 mb-4">è¨­å®šãƒ»ç·¨é›†ã«ã¯ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™</p>

                <label className="block text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-2">
                  ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ / Password
                </label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && handlePasswordSubmit()}
                  placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
                  className="w-full px-4 py-3 bg-gray-800 border border-gray-700 text-white text-base font-medium rounded-md focus:outline-none focus:border-blue-500 mb-4"
                  autoFocus
                />

                <div className="grid grid-cols-2 gap-3">
                  <button
                    onClick={handlePasswordSubmit}
                    className="px-4 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors"
                  >
                    èªè¨¼
                  </button>
                  <button
                    onClick={() => { setShowPasswordModal(false); setPassword(''); }}
                    className="px-4 py-3 bg-gray-800 border border-gray-700 text-gray-300 font-medium rounded-lg hover:bg-gray-700 transition-colors"
                  >
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                  </button>
                </div>
              </div>
            </div>
          )}
        </>
      );
    }

    // é€šå¸¸ã¯ç¾å ´é¸æŠç”»é¢ï¼ˆãŸã ã—ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚‚åŒéšå±¤ã§æç”»ã™ã‚‹ï¼‰
    console.log('ğŸ—ï¸ LOGIOApp: Rendering SiteSelectionPage');
    return (
      <>
        <SiteSelectionPage
          sites={sites}
          onSelectSite={handleSelectSite}
          onRequestAddSite={handleRequestAddSite}
        />

        {showPasswordModal && (
          <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 px-4">
            <div className="bg-gray-900 p-6 max-w-md w-full rounded-lg border border-gray-700">
              <h2 className="text-xl font-bold text-white mb-4">ç®¡ç†è€…èªè¨¼</h2>
              <p className="text-sm text-gray-400 mb-4">è¨­å®šãƒ»ç·¨é›†ã«ã¯ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™</p>

              <label className="block text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-2">
                ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ / Password
              </label>
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && handlePasswordSubmit()}
                placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
                className="w-full px-4 py-3 bg-gray-800 border border-gray-700 text-white text-base font-medium rounded-md focus:outline-none focus:border-blue-500 mb-4"
                autoFocus
              />

              <div className="grid grid-cols-2 gap-3">
                <button
                  onClick={handlePasswordSubmit}
                  className="px-4 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors"
                >
                  èªè¨¼
                </button>
                <button
                  onClick={() => { setShowPasswordModal(false); setPassword(''); }}
                  className="px-4 py-3 bg-gray-800 border border-gray-700 text-gray-300 font-medium rounded-lg hover:bg-gray-700 transition-colors"
                >
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
              </div>
            </div>
          </div>
        )}
      </>
    );
  }

  console.log('ğŸ  LOGIOApp: Rendering main app');

  return (
    <div className="min-h-screen bg-black flex">
      <Sidebar 
        currentPage={currentPage} 
        onNavigate={handleNavigate} 
        sidebarOpen={sidebarOpen}
        setSidebarOpen={setSidebarOpen}
      />

      <div className="md:pl-64 flex flex-col flex-1 bg-black">
        <div className="md:hidden">
          <Header showMenuButton onMenuClick={() => setSidebarOpen(true)} />
        </div>

        <div className="hidden md:block">
          <Header />
        </div>

        <main className="flex-1">
          {currentPage === 'home' && <HomePage sites={sites} selectedSite={selectedSite} onSelectSite={handleSelectSite} onNavigate={handleNavigate} totals={totals} projectInfo={projectInfo} />}
          {currentPage === 'settings' && <ProjectSettingsPage sites={sites} selectedSite={selectedSite} projectInfo={projectInfo} setProjectInfo={setProjectInfo} onSave={handleSaveProject} onAddSite={handleAddSite} onDeleteSite={handleDeleteSite} onNavigate={setCurrentPage} />}
          {currentPage === 'input' && <ReportInputPage onSave={handleSaveReport} onNavigate={setCurrentPage} />}
          {currentPage === 'list' && <ReportListPage reports={reports} onDelete={handleDeleteReport} onNavigate={setCurrentPage} />}
          {currentPage === 'analysis' && <AnalysisPage reports={reports} totals={totals} projectInfo={projectInfo} onNavigate={setCurrentPage} />}
        </main>
      </div>

      {showPasswordModal && (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 px-4">
          <div className="bg-gray-900 p-6 max-w-md w-full rounded-lg border border-gray-700">
            <h2 className="text-xl font-bold text-white mb-4">ç®¡ç†è€…èªè¨¼</h2>
            <p className="text-sm text-gray-400 mb-4">è¨­å®šãƒ»ç·¨é›†ã«ã¯ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™</p>
            
            <label className="block text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-2">
              ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ / Password
            </label>
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              onKeyDown={(e) => e.key === 'Enter' && handlePasswordSubmit()}
              placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
              className="w-full px-4 py-3 bg-gray-800 border border-gray-700 text-white text-base font-medium rounded-md focus:outline-none focus:border-blue-500 mb-4"
              autoFocus
            />

            <div className="grid grid-cols-2 gap-3">
              <button
                onClick={handlePasswordSubmit}
                className="px-4 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors"
              >
                èªè¨¼
              </button>
              <button
                onClick={() => { setShowPasswordModal(false); setPassword(''); }}
                className="px-4 py-3 bg-gray-800 border border-gray-700 text-gray-300 font-medium rounded-lg hover:bg-gray-700 transition-colors"
              >
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
